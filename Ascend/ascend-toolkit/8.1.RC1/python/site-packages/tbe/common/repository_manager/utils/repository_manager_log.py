#!/usr/bin/env python
# -*- coding:utf-8 -*-
"""
Copyright (C) 2022. Huawei Technologies Co., Ltd. All rights reserved.

Define log service
"""
import inspect
import traceback
import os

from typing import Any
from tbe.common.utils import log

MODULE_NAME = "repository_manager"
FILE_PATH = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))


class RepositoryManagerSLog:
    """tiling manager log class"""
    def __init__(self) -> None:
        self.logger = log

    def log(self, level: str, msg: Any, *args: Any) -> Any:
        """common log"""
        line = inspect.currentframe().f_back.f_back.f_lineno
        co_filename = inspect.currentframe().f_back.f_back.f_code.co_filename
        filename = os.path.relpath(co_filename, FILE_PATH)
        log_str = "[%s:%d][%s] %s" % (filename, line, MODULE_NAME, str(msg) % args)
        getattr(self.logger, level)(log_str)

    def info(self, msg: Any, *args: Any) -> Any:
        """as same as self.log"""
        self.log("info", msg, *args)

    def debug(self, msg: Any, *args: Any) -> Any:
        """as same as self.log"""
        self.log("debug", msg, *args)

    def error(self, msg: Any, *args: Any) -> Any:
        """as same as self.log"""
        self.log("error", msg, *args)

    def warn(self, msg: Any, *args: Any) -> Any:
        """as same as self.log"""
        self.log("warn", msg, *args)

    def event(self, msg: Any, *args: Any) -> Any:
        """as same as self.log"""
        self.log("info", msg, *args)


def get_py_exception_dict(etype: object, value: object, tback: object) -> dict:
    """
    return python exception dict, calling from C for error log uploading
    """
    _ = traceback.format_exception(etype, value, tback)
    err_msg = value.args
    err_dict = {}
    if isinstance(err_msg, tuple) and err_msg[0] and isinstance(err_msg[0], dict):
        for dict_key, dict_value in err_msg[0].items():
            err_dict[dict_key] = str(dict_value)
        return err_dict
    if isinstance(err_msg, tuple):
        message_list = []
        for tuple_element in err_msg:
            if not isinstance(tuple_element, str):
                message_list.append(str(tuple_element))
            else:
                message_list.append(tuple_element)
        err_dict['errCode'] = 'E90000'
        err_dict['message'] = "".join(message_list)
        err_dict['traceback'] = "".join(traceback.format_tb(tback))
        return err_dict
    return err_dict


def get_py_exception_str(etype: object, value: object, tback: object, eprint: bool = False) -> list:
    """
    return python exception string, calling from C for error log printing
    """
    exc_list = traceback.format_exception(etype, value, tback)
    msg_list = []
    for item in exc_list:
        for msg in item.split("\n"):
            msg_list.append(msg)

    if eprint:
        traceback.print_exception(etype, value, tback)

    return msg_list


LOG_INSTANCE = RepositoryManagerSLog()
