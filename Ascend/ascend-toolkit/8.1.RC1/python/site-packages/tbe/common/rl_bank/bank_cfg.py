#!/usr/bin/env python3
# -*- coding:utf-8 -*-
# Copyright 2019-2020 Huawei Technologies Co., Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ============================================================================
"""
Define some config for rl bank
"""
import os
import stat
import fcntl

from tbe.common import platform
from tbe.common.utils import log

OPEN_FILE_FLAGS = os.O_WRONLY | os.O_CREAT
WRITE_FILE_FLAGS = os.O_WRONLY | os.O_CREAT | os.O_TRUNC
OPEN_FILE_MODES_640 = stat.S_IWUSR | stat.S_IRUSR | stat.S_IRGRP
DIR_MODE_750 = 0o750


DTYPE_INDEX = {
    'int8': 1,
    'uint8': 2,
    'int16': 3,
    'uint16': 4,
    'int32': 5,
    'uint32': 6,
    'int64': 7,
    'uint64': 8,
    'float16': 9,
    'bfloat16': 10,
    'float32': 11,
    'float64': 12,
    'bool': 13,
    'uint1': 14,
    'unknown': 0
}

TAG_INDEX = {
    '': 0,
    'mem_copy': 0,
    'elewise_single_log': 1,
    'elewise_single_exp': 2,
    'elewise_single_rec': 3,
    'elewise_single_VS_add': 4,
    'elewise_single_VS_mul': 5,
    'elewise_single_abs': 6,
    'elewise_single_relu': 7,
    'elewise_single_not': 8,
    'elewise_single_sqrt': 9,
    'elewise_binary_add': 10,
    'elewise_binary_sub': 11,
    'elewise_binary_mul': 12,
    'elewise_binary_min': 13,
    'elewise_binary_max': 14,
    'elewise_binary_or': 15,
    'elewise_binary_and': 16,
    'elewise_binary_scalar_axpy': 17,
    'elewise_multiple_mla': 18,
    'elewise_multiple_madd': 19,
    'elewise_multiple_maddrelu': 20,
    'reduce_sum': 21,
    'reduce_sum_nist': 22,
    'reduce_min': 23,
    'reduce_min_nist': 24,
    'reduce_max': 25,
    'reduce_max_nist': 26,
    'reduce_prod': 27,
    'reduce_prod_nist': 28,
    'broadcast_for_tensor': 29,
    'elewise_single_cast': 30,
    'elewise_single_round': 31,
    'elewise_single_ceil': 32,
    'elewise_single_floor': 33,
    'elewise_single_trunc': 34,
    'segment_sum': 35,
    'load2d': 36,
    'transpose_true': 37,
    'matmul': 38,
    'set_fmatrix': 39,
    'im2col': 40,
    'conv_mad': 41,
    'out_to_l1': 42,
    'vector_dup': 43,
    'l1_to_l0': 44,
    'mov_backup': 45,
    'broadcast': 46,
    'elewise_binary_div': 47,
    'elewise_single_VS_max': 48,
    'elewise_single_VS_min': 49,
    'elewise_single_rsqrt': 50,
    'elewise_binary_vcmpv_gt': 51,
    'elewise_binary_vcmpv_ge': 52,
    'elewise_binary_vcmpv_lt': 53,
    'elewise_binary_vcmpv_le': 54,
    'elewise_binary_vcmpv_eq': 55,
    'elewise_binary_vcmpv_ne': 56,
    'vector_auto': 57,
    'emit_insn_elewise_multiple_sel': 58,
    'emit_insn_elewise_binary_cmp': 59,
    'elewise_binary_cmpsel': 60,
    'elewise_single_VS_cond': 61,
    'elewise_binary_logic': 62,
    'elewise_binary_compare_lt': 63,
    'elewise_binary_compare_gt': 64,
    'elewise_single_VS_mul_with_reg_in_quant': 65,
    'elewise_single_VS_adds_with_reg': 66,
    'elewise_single_VS_mul_with_reg_sqrt_in_quant': 67,
    'elewise_single_VS_mul_with_reg': 68,
    'elewise_single_VS_add_with_reg': 69,
    'elewise_single_diagonal': 70,
    'tuple_reduce_sum': 71,
    'concat': 72,
    'elewise_empty_intrin': 73,
    'strided_slice_d': 74,
    'split_com': 75,
    'write_select': 76,
    'elewise_single_round_d': 77,
    'elewise_single_lrelu': 78,
    'elewise_binary_addrelu': 79,
    'elewise_binary_subrelu': 80,
    'elewise_binary_phony': 81,
    'elewise_binary_cmpsel_eq': 82,
    'elewise_binary_cmpsel_ne': 83,
    'out_to_ub': 84,
    'ub_to_out': 85,
    'dequant_remove_pad': 86,
    'dequant_vector': 87,
    'conv_vector_remove_pad': 88,
    'convolution_im2col_row_major': 89,
    'convolution_row_major_reshape': 90,
    'convolution__im2col_fractal': 91,
    'convolution_c_col': 92,
    'data_transfer': 93,
    'requant_remove_pad': 94,
    'requant_vector': 95,
    'quant': 96,
    'conv_l1fuse_reshape': 97,
    'dequant_s16_vector': 98,
    'dequant_s16_remove_pad': 99,
    'requant_s16_vaddrelu': 100,
    'requant_s16_vector': 101,
    'conv_virtual_res': 102,
    'res_remove_pad_u8': 103,
    'res_remove_pad_s16': 104,
    'res_out_fp16': 105,
    'convolution_im2col_fractal': 106,
    'requant_s16_data_transfer': 107,
    'phony_insn': 108,
    'elewise_binary_cmpsel_gt': 109,
    'elewise_binary_cmpsel_ge': 110,
    'elewise_multiple_sel': 111,
    'empty_intrin': 112,
    'unified_broadcast': 113,
    'transpose': 114,
    'unknown_broadcast': 115,
    'set_value': 116,
    'one_shape_broadcast': 117,
    'one_rank_broadcast': 118,
    'reduce_window_max': 119,
    'pad_window': 120,
    'elewise_binary_cmpsel_lt': 121,
    'split': 122,
}

INTRIN_MAP = {
    0: 'dma_copy',
    1: 'vector_ln',
    2: 'vector_exp',
    3: 'elewise_single_rec',
    4: 'vector_adds',
    5: 'vector_muls',
    6: 'vector_abs',
    7: 'vector_relu',
    8: 'vector_not',
    9: 'vector_sqrt',
    10: 'vector_add',
    11: 'vector_sub',
    12: 'vector_mul',
    13: 'vector_min',
    14: 'vector_max',
    15: 'vector_or',
    16: 'vector_and',
    17: 'vector_axpy',
    18: 'phony_insn',
    19: 'vector_mul_with_broadcast',
    20: 'vector_add_with_broadcast',
    21: 'vector_reduce_sum',
    22: 'replace_output',
    23: 'vector_reduce_min',
    24: 'reuse_input',
    25: 'vector_reduce_max',
    26: 'vector_mul_with_broadcast_enhance',
    27: 'reduce_last_axis_reduce_prod',
    28: 'vector_min_with_broadcast_enhance',
    29: 'broadcast_for_tensor',
    30: 'vector_conv',
    31: 'elewise_single_round',
    32: 'elewise_single_ceil',
    33: 'elewise_single_floor',
    34: 'elewise_single_trunc',
    35: 'segment_sum',
    36: 'vector_add_with_broadcast_enhance',
    37: 'vector_rec',
    38: 'mad',
    39: 'set_fmatrix',
    40: 'im2col',
    41: 'vector_div_with_broadcast_enhance',
    42: 'vector_div_with_broadcast',
    43: 'vector_dup',
    44: 'vector_sub_with_broadcast',
    45: 'mov_backup',
    46: 'broadcast',
    47: 'vector_div',
    48: 'vector_maxs',
    49: 'vector_mins',
    50: 'vector_rsqrt',
    51: 'vector_gt',
    52: 'vector_ge',
    53: 'vector_lt',
    54: 'vector_le',
    55: 'vector_eq',
    56: 'vector_ne',
    57: 'vector_auto',
    58: 'elewise_multiple_sel',
    59: 'elewise_binary_cmp',
    60: 'vector_cmpsel',
    61: 'elewise_single_VS_cond',
    62: 'elewise_binary_logic',
    63: 'elewise_binary_compare_lt',
    64: 'elewise_binary_compare_gt',
    65: 'elewise_single_VS_mul_with_reg_in_quant',
    66: 'elewise_single_VS_adds_with_reg',
    67: 'elewise_single_VS_mul_with_reg_sqrt_in_quant',
    68: 'elewise_single_VS_mul_with_reg',
    69: 'elewise_single_VS_add_with_reg',
    70: 'elewise_single_diagonal',
    71: 'vector_dichotomy_add_for_bn_reduce',
    72: 'broadcast_for_tensor_opt',
    73: 'vector_dichotomy_add',
    74: 'unified_broadcast',
    75: 'vector_sub_with_broadcast_enhance',
    76: 'vector_reduce_sum_last_axis_opt',
    77: 'vector_dichotomy_reduce',
    78: 'reduce_last_axis_reduce_sum_2',
    79: 'reduce_last_axis_reduce_max_2',
    80: 'vector_mla',
    81: 'vector_madd',
    82: 'vector_maddrelu',
    83: 'reuse_output',
    84: 'json_info_cache_read_mode',
    85: 'vector_conv_round',
    86: 'vector_lrelu',
    87: 'vector_addrelu',
    88: 'vector_subrelu',
    89: 'elewise_binary_phony',
    90: 'vector_multiple',
    91: 'vector_conv_rint',
    92: 'vector_conv_floor',
    93: 'vector_conv_trunc',
    94: "vector_select_eq",
    95: "vector_select_ne",
    96: 'vector_conv_vdeq',
    97: "vector_select_gt",
    98: "vector_select_ge",
    99: "vector_select_bool",
    100: "vector_broadcast",
    101: "vector_transpose",
    102: "align_pad",
    103: "vector_select_le",
    104: "unknown_broadcast",
    105: "axis_group",
    106: "remove_pad",
    107: "vector_reduce",
    108: "vector_select_lt",
    109: "local.UB_fragments_memory_size",
    110: "vnchwconv",
}

PRIMITIVE_DICT = {
    0: 'cache_read',
    1: 'cache_write',
    2: 'double_buffer',
    3: 'compute_inline',
    4: 'get_axis',
    5: 'get_reduce_axis',
    6: 'split',
    7: 'split_nparts',
    8: 'reorder',
    9: 'compute_at',
    10: 'bind',
    11: 'emit_insn',
    12: 'broadcast_axis_offset',
    13: 'storage_align',
    14: 'cce_special',
    15: 'fuse',
    16: 'pragma',
    17: 'rfactor',
    18: 'set_scope',
    19: 'reused_by',
    20: 'preload',
    21: 'allocate_at',
    22: 'mem_unique',
    23: 'allocate_root',
    24: 'bind_buffer',
    25: 'buffer_align',
    26: 'buffer_tile',
    27: 'compute_root',
    28: 'cycle_double_buffer',
    29: 'enable_mte4_mte5',
    30: 'env_threads',
    31: 'handle',
    32: 'opengl',
    33: 'parallel',
    34: 'partition',
    35: 'prefetch',
    36: 'remove_init',
    37: 'same_as',
    38: 'set_block_sync',
    39: 'set_buffer_size',
    40: 'set_store_predicate',
    41: 'specify_storage',
    42: 'speel',
    43: 'tensorize',
    44: 'tile',
    45: 'unreused_by',
    46: 'unroll',
    47: 'vectorize',
    48: 'wait_block_sync',
    49: 'tbe_compile_para',
    50: 'sub_bind',
    51: 'set_constraint',
    52: 'cache_clone',
    53: 'compute_align',
    54: 'build_config',
    55: 'compute_with',
    56: 'call_extern',
}

SCOPE_DICT = {
    0: platform.scope_gm,
    1: platform.scope_ubuf,
    2: platform.scope_cbuf,
    3: platform.scope_ca,
    4: platform.scope_cb,
    5: platform.scope_cc,
    6: platform.scope_reg,
    7: platform.scope_aicpu,
    8: "",
    9: platform.scope_cbuf_fusion
}

SPEC_ATTR_KEY = [
    "addr_type", "valid_shape", "slice_offset", "L1_addr_flag", "L1_addr_offset", "L1_valid_size",
    "L1_fusion_type"
]

TBE_COMPILE_PARA_DICT = {
    0: "pipeline_opt",
    1: "read_write_bank_conflict",
    2: "out_of_order"
}

BUILD_CONFIG_DICT = {
    0: "enable_loop_partition",
    1: "enable_precise_sync_in_emit_insn",
    2: "out_of_bound_sync_check",
    3: "enable_branch_eliminator_else_case",
    4: "constant_realize_extent_in_infer_bound"
}

MODE_RUNTIME = "runtime"
MODE_OFFLINE = "offline"


class ScheduleTarget():  # pylint: disable=too-few-public-methods
    '''
    ScheduleTarget
    '''

    def __init__(self, name, obj, axes):
        self.name = name.strip()
        self.obj = obj
        # reduce axis shoule be after comm aixs
        self.axes = axes


class Axis():  # pylint: disable=too-few-public-methods
    '''
    Axis
    '''

    def __init__(self, name, obj):
        self.name = name.strip()
        self.obj = obj

    def update_name(self, new_name):
        """
        update name
        """
        new_name = new_name.strip()
        if isinstance(self.name, str):
            self.name = [self.name, new_name]
        elif isinstance(self.name, list):
            if new_name not in self.name:
                self.name.append(new_name)
        else:
            raise RuntimeError("axis name must be string or list!")


def create_dir(dir_path: str) -> bool:
    """
    create dir
    :param dir_path:
    :return: T/F
    """
    dir_path = os.path.realpath(dir_path)
    is_exists = os.path.exists(dir_path)
    if not is_exists:
        try:
            os.makedirs(dir_path, DIR_MODE_750, exist_ok=True)
        except (OSError, TypeError) as excep:
            log.error("Failed to create dir: %s, raise exception: %s", dir_path, repr(excep))
            raise excep
        finally:
            pass
    log.info("create_dir: %s, is_exists: %s.", repr(dir_path), repr(is_exists))
    return True


def write_to_file(file_path: str, content: str = "") -> bool:
    """
    write to file
    :param file_path:
    :param content:
    :return: T/F
    """
    dir_name = os.path.dirname(file_path)
    ret = create_dir(dir_name)
    if not ret:
        log.warn("can not create dir: %s.", dir_name)
        return False

    with os.fdopen(os.open(file_path, OPEN_FILE_FLAGS, OPEN_FILE_MODES_640), 'w') as file_handler:
        file_handler.write(content)
    return True


class LocalLock:
    """
    LocalLock
    """
    def __init__(self, lock_file: str) -> None:
        if not os.path.exists(lock_file):
            log.debug("lock_file: %s not exist!", lock_file)
            write_to_file(lock_file)
        self.lock_fd = os.open(lock_file, OPEN_FILE_FLAGS, OPEN_FILE_MODES_640)

    def lock(self) -> None:
        """
        lock
        """
        fcntl.flock(self.lock_fd, fcntl.LOCK_EX)

    def unlock(self) -> None:
        """
        unlock
        """
        os.close(self.lock_fd)
