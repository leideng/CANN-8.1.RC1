#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
import numpy as np

from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.controller.mcts_search.mask_rules.mask_cfg import MASK_CFG


def proc(progress):
    """对代码有一定的要求：
    1, Tensor要有name,且与变量名保持一致，且不同Stage的名字不要相同，比如：
    A = tvm.placeholder(shape, name="A", dtype=dtype)
    B = tvm.compute(shape, lambda *indice:  tvm.log(A(*indice)),name="B")
    2, 对于cache_read/cache_write，其命名固定为对应变量加L，比如：
    AL = s.cache_read(A, scope_ubuf, [B])
    BL = s.cache_write(B, scope_ubuf)
    """
    # 默认全是合法的
    action_mask = np.array([1] * SEARCH_N, dtype=int)

    if progress.todo is None:
        return action_mask

    for proc_items in sorted(MASK_CFG.items(), key=lambda x: x[0]):
        proc_cfg = proc_items[1]
        action_type = proc_cfg['action_type']
        if progress.todo.action_type == action_type:
            proc_name = proc_cfg['proc_name']
            rules = proc_cfg['rules']

            module = __import__(proc_name, fromlist=['1'])
            action_mask = module.proc(progress, action_mask, rules)

    return action_mask
