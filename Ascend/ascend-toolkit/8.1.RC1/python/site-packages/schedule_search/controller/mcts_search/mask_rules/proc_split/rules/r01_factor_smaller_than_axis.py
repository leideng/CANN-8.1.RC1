#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.ts_env.tensor_cfg import AXIS_CNT
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg


def proc(progress, action_mask):
    """
    规则内容：factor切分因子必须比自身轴长小，大于轴长的都需要mask掉
    """
    stage_index = progress.todo.stage_index
    curr_stage_nonzero_axes = progress.get_nonzero_axes(stage_index)

    factor_index = \
        ActionTensorCfg.split_factor_s + \
        progress.todo.cache_layer * AXIS_CNT + \
        progress.todo.axis_index
    # 获取已有factor
    factor = progress.action_tensor[stage_index][factor_index]
    # 获取axis轴长
    axis_len = curr_stage_nonzero_axes[progress.todo.axis_index]

    for i in range(SEARCH_N):
        next_factor \
            = factor + pow(SEARCH_N, progress.todo.sub_action_index) * i
        if next_factor > axis_len:
            action_mask[i] = 0
    log.dbg("r01 axis_len:%s action_mask:%s", axis_len, action_mask)

    return action_mask
