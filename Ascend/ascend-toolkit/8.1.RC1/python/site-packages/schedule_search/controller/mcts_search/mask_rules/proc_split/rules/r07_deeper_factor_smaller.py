#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search import comm
from schedule_search.ts_env.tensor_cfg import AXIS_CNT
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.controller.mcts_search.procedure.comm import \
    is_mad_leaf


def condition_check(progress):
    '''
    :param progress:
    :return:
    '''
    # gemm不切mn，则不需要保证MN的切分大于mn的切分
    if progress.c_op in comm.MAD_OP_ID_LIST and is_mad_leaf(progress):
        need_split_l0 = progress.op_schedule_info.stages_info[
            progress.todo.stage_index].get('need_split_l0')
        if need_split_l0 is False:
            return False

    # 最后一层cache不需要处理
    if progress.todo.cache_layer == progress.op_layers - 1:
        return False

    return True


def proc(progress, action_mask):
    '''
    规则内容：深层的buffer的切分因子要比外层的小
    比如，先切L0后，再切L1，要确保L1的切分因子要比L0的大
    '''
    if not condition_check(progress):
        return action_mask

    stage_index = progress.todo.stage_index
    sub_action_index = progress.todo.sub_action_index
    factor_index = ActionTensorCfg.split_factor_s + \
                   progress.todo.cache_layer * AXIS_CNT + \
                   progress.todo.axis_index

    # 获取深层buffer的切分因子
    deeper_factor_index = factor_index + AXIS_CNT
    deeper_factor = progress.action_tensor[stage_index][deeper_factor_index]

    # 获取已有factor
    factor = progress.action_tensor[stage_index][factor_index]

    # mask
    for idx in range(SEARCH_N):
        new_factor = factor + pow(SEARCH_N, sub_action_index) * idx
        if new_factor < deeper_factor:
            action_mask[idx] = 0

    log.dbg('r07 deeper factor smaller: %s', action_mask)
    return action_mask
