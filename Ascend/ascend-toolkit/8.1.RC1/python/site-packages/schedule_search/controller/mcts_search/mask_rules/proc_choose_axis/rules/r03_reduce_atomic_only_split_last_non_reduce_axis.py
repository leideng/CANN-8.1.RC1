#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.ts_env import env_util


def proc(progress, action_mask):  # pylint: disable=R0912
    """
    规则内容：reduce atomic如果切普通轴，只能切最后一根非reduce轴，
    这里最后一根是广义的，可能包含多根连续reduce的轴
    """
    # 不是reduce atomic就不处理了
    stage_index = progress.todo.stage_index
    stage_info = progress.op_schedule_info.stages_info[stage_index]
    if 'reduce_atomic' not in stage_info.get('type', []):
        return action_mask

    # 切reduce轴就不处理了
    split_axis_type = stage_info.get('split_axis_type', 'reduce_axis')
    if split_axis_type == 'reduce_axis':
        return action_mask

    # 获取最后一根非reduce轴的index范围
    shape_before_reduce = stage_info.get('shape_before_reduce', [])
    reduce_axis_indexs = stage_info.get('reduce_axis_indexs', [])
    is_keepdims = stage_info.get('is_keepdims', False)
    last_none_reduce_axis_s, last_none_reduce_axis_e = \
        env_util.find_last_none_reduce_axis(shape_before_reduce,
                                            reduce_axis_indexs)
    start_index = env_util.find_none_reduce_axis_index(last_none_reduce_axis_s,
                                                       shape_before_reduce,
                                                       reduce_axis_indexs,
                                                       is_keepdims=is_keepdims)
    end_index = env_util.find_none_reduce_axis_index(last_none_reduce_axis_e,
                                                     shape_before_reduce,
                                                     reduce_axis_indexs,
                                                     is_keepdims=is_keepdims)
    for idx in range(SEARCH_N):
        if start_index <= idx <= end_index:
            action_mask[idx] = 1
        else:
            action_mask[idx] = 0

    return action_mask
