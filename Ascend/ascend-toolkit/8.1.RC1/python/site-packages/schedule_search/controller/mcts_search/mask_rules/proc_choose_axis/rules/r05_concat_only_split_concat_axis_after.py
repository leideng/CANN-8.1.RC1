#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.controller.mcts_search.features import SEARCH_N


def proc(progress, action_mask):  # pylint: disable=R0912
    """
    规则内容：
    concat算子只能切concat_axis以及该轴之后的轴
    """
    # 不是最后一个stage不处理
    if progress.todo.stage_index != progress.stage_num - 1:
        return action_mask

    # 不是concat算子不处理
    if not progress.op_schedule_info.concat_dict:
        return action_mask

    nonzero_axes = progress.get_nonzero_axes(progress.todo.stage_index)
    concat_axis = progress.op_schedule_info.concat_dict['concat_axis']

    # concat_axis之前的轴，不包括concat_axis，全部mask
    for idx in range(SEARCH_N):
        if idx < concat_axis:
            action_mask[idx] = 0

    # 不能全部被mask
    if sum(action_mask) == 0:
        for idx in range(SEARCH_N):
            if concat_axis <= idx <= len(nonzero_axes) - 1:
                action_mask[idx] = 1

    return action_mask
