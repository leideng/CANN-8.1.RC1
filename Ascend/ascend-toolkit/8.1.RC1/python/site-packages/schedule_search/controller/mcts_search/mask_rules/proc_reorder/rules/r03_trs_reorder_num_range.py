#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from math import factorial
from numpy import ndarray

from schedule_search.op_cfg import TIK_TO_DSL_OP_LIST
from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.controller.mcts_search.schedule import Progress


def proc(progress: Progress, action_mask: ndarray) -> ndarray:
    """
    规则内容：reorder num可选的范围为axis排列组合个数
    :param progress: Progress
    :param action_mask: action mask
    :return: action mask
    """
    stage_index = progress.todo.stage_index
    stage_info = progress.op_schedule_info.stages_info[stage_index]

    op_type = progress.op_schedule_info.option.get('op_type')
    trs_reorder_flag = op_type in TIK_TO_DSL_OP_LIST.keys() and \
                       "trs_reorder_times" in TIK_TO_DSL_OP_LIST.get(op_type).keys()
    if not trs_reorder_flag:
        return action_mask

    nonzero_axes = progress.get_nonzero_axes(stage_index)
    # 获取reorder_num的最大值， 各axis排列组合个数
    max_reorder_num = factorial(len(nonzero_axes))

    # 获取已有reorder_num
    reorder_num = stage_info.get('trs_reorder_num', 0)

    # 超过max_reorder_num mask掉
    for i in range(SEARCH_N):
        next_reorder_num = reorder_num + pow(
            SEARCH_N, progress.todo.sub_action_index) * i
        if next_reorder_num >= max_reorder_num:
            action_mask[i] = 0

    # 不能全部都mask掉
    if sum(action_mask) == 0:
        action_mask[0] = 1

    return action_mask
