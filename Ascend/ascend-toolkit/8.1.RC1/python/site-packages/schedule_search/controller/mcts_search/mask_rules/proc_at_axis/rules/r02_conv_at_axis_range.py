#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
import numpy as np
from schedule_search import log
from schedule_search import comm
from schedule_search.controller.mcts_search.procedure.comm import \
    need_search_at_axis


def proc(progress, action_mask):
    """
    规则内容：at_axis的范围为 0-3
    """
    stage_index = progress.todo.stage_index
    op_schedule_info = progress.op_schedule_info
    if op_schedule_info.c_op not in comm.CONV_OP_ID_LIST:
        return action_mask

    if not need_search_at_axis(stage_index, op_schedule_info):
        return action_mask

    need_split_l0 = progress.op_schedule_info.stages_info[-1].get(
        'need_split_l0')
    if need_split_l0:
        action_mask = np.array([1, 1, 1, 0, 0, 0, 0, 0])
    else:
        action_mask = np.array([1, 1, 1, 1, 0, 0, 0, 0])

    conv_param_dict = progress.op_schedule_info.conv_param_dict
    if stage_index in conv_param_dict:
        dma_full = conv_param_dict[stage_index]["dma_full"]
        if dma_full is False:
            action_mask[0] = 0
    log.dbg('stage: %s, r02_normal_at_axis_range: %s', stage_index,
            action_mask)
    return action_mask
