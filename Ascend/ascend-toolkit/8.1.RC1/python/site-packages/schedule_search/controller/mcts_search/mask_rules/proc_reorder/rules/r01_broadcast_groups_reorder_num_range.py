#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from math import factorial

from schedule_search.controller.mcts_search.features import SEARCH_N


def proc(progress, action_mask):
    """
    规则内容：broadcast_groups reorder num可选的范围为broadcast_groups排列组合个数
    """
    stage_index = progress.todo.stage_index
    stage_info = progress.op_schedule_info.stages_info[stage_index]
    broadcast_groups = stage_info.get('broadcast_groups')
    if not broadcast_groups:
        return action_mask

    # 获取reorder_num的最大值， 各broadcast_groups排列组合个数
    max_reorder_num = factorial(len(broadcast_groups))

    # 获取已有reorder_num
    reorder_num = stage_info.get('broadcast_groups_reorder', 0)

    # 超过max_reorder_num mask掉
    for i in range(SEARCH_N):
        next_reorder_num = reorder_num + pow(
            SEARCH_N, progress.todo.sub_action_index) * i
        if next_reorder_num >= max_reorder_num:
            action_mask[i] = 0

    # 不能全部都mask掉
    if sum(action_mask) == 0:
        action_mask[0] = 1

    return action_mask
