#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.controller.mcts_search.procedure.action import ActionType

MASK_CFG = {
    20: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.proc_at_stage.main',
        'action_type':
        ActionType.at_stage,
        'rules': [
            # 把超出范围的at_stage给Mask掉
            'schedule_search.controller.mcts_search.mask_rules.proc_at_stage.'
            'rules.r01_keep_in_range',
        ]
    },
    40: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.proc_split.main',
        'action_type':
        ActionType.split,
        'rules': [
            # 切分因子小于轴长 通用
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r01_factor_smaller_than_axis',
            # ReduceLast的Stage中，Reduce轴的尾块不能为1 reduce,不变
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r03_reduce_last_reduce_tail_not_1',
            # 切分出来的块必须大于32byte，尾块没有要求
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r05_factor_larger_than_32_byte',
            # atomic reduce nist切普通轴，需要保证尾块32对齐
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r06_reduce_atomic_32b_align',
            # 深层的buffer的切分因子要比外层的小
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r07_deeper_factor_smaller',
            # gemm不超过L0 buffer的大小
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r08_gemm_smaller_than_l0_buffer',
            # gemm不超过L1 buffer的大小
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r09_gemm_smaller_than_l1_buffer',
            # gemm不超过ub buffer的大小
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r10_gemm_smaller_than_ub_buffer',
            # gemm大K切的时候保证小k整吃
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r11_gemm_k_32b_align',
            # gemm的搜索空间比较大，难搜，限制切分因子不能过大、过小
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r12_gemm_factor_range_rule',
            # 搜索空间比较大，难搜，限制切分因子只能为整除轴长的、2的整数次幂
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r13_divisible_and_2_integer_power_rule',
            # for transpose
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r14_transpose_factor_size_smaller_than_bound',
            # 对于采用vtranspose进行的broadcast策略，会占用额外内存空间，对repeat_time进行限制
            'schedule_search.controller.mcts_search.mask_rules.proc_split.'
            'rules.r15_unified_broadcast_size_smaller_than_buffer',
        ]
    },
    50: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.proc_reorder.main',
        'action_type':
        ActionType.reorder,
        'rules': [
            # broadcast_groups reorder num可选的范围为broadcast_groups排列组合个数
            'schedule_search.controller.mcts_search.mask_rules.proc_reorder.'
            'rules.r01_broadcast_groups_reorder_num_range',
            # gemm只采样两种reorder顺序，mn or nm
            'schedule_search.controller.mcts_search.mask_rules.proc_reorder.'
            'rules.r02_gemm_reorder',
            # trs reorder rule
            'schedule_search.controller.mcts_search.mask_rules.proc_reorder.'
            'rules.r03_trs_reorder_num_range',
        ]
    },
    60: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.proc_at_axis.main',
        'action_type':
        ActionType.at_axis,
        'rules': [
            # broadcast groups at axis的采样范围
            'schedule_search.controller.mcts_search.mask_rules.proc_at_axis.'
            'rules.r01_broadcast_groups_at_axis_range',
            # conv at axis的采样范围
            'schedule_search.controller.mcts_search.mask_rules.proc_at_axis.'
            'rules.r02_conv_at_axis_range',
            # at axis的采样范围
            'schedule_search.controller.mcts_search.mask_rules.proc_at_axis.'
            'rules.r03_normal_at_axis_range',
        ]
    },
    80: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.proc_choose_axis.'
        'main',
        'action_type':
        ActionType.choose_axis,
        'rules': [
            # 选轴时，不能选择后面轴乘积大于Buffer的轴
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_choose_axis.rules.r01_axis_smaller_than_buffer',
            # reduce atomic如果切普通轴，只能切最后一根非reduce轴，
            # 这里最后一根是广义的，可能包含多根连续reduce的轴
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_choose_axis.rules.'
            'r03_reduce_atomic_only_split_last_non_reduce_axis',
            # 算子包含broadcast_nist，且最后一根broadcast轴之后的所有普通轴
            # 不是32b对齐的，则只能切最后一根broadcast轴之后的普通轴
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_choose_axis.rules.'
            'r04_broadcast_only_split_max_broadcast_after',
            # concat算子只能切concat_axis以及该轴之后的轴
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_choose_axis.rules.r05_concat_only_split_concat_axis_after',
        ]
    },
    100: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.'
        'proc_choose_axis_type.main',
        'action_type':
        ActionType.choose_axis_type,
        'rules': [
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_choose_axis_type.rules.r01_only_two_axis_types',
        ]
    },
    120: {
        'proc_name':
        'schedule_search.controller.mcts_search.mask_rules.'
        'proc_need_split_l0.main',
        'action_type':
        ActionType.need_split_l0,
        'rules': [
            # 是否切mn，只有切或不切
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_need_split_l0.rules.r01_split_or_not_split',
        ]
    },
    140: {
        'proc_name':
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_emit_insn.main',
        'action_type':
            ActionType.emit_insn,
        'rules': [
            'schedule_search.controller.mcts_search.mask_rules.'
            'proc_emit_insn.rules.r01_mask_for_multi_insns',
        ]
    },
}
