#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.ts_env.tensor_cfg import AXIS_CNT
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.ts_env.tensor_cfg import FeatureTensorCfg
from schedule_search.ts_env.tensor_to_code import t2c_util


def proc(progress, action_mask):
    """
    规则内容：reduce_last的IR约束，要求factor和尾块均不能是1
    """
    # 尾块是否是1应该factor最后一次采样来看
    if progress.todo.sub_action_index == 0:
        stage_index = progress.todo.stage_index
        feature_vector = progress.op_schedule_info.feature_tensor[stage_index]
        compute_index = feature_vector[FeatureTensorCfg.compute_s]
        op_intrin_key_index = progress.op_schedule_info.op_intrin_key_index
        compute_tag = op_intrin_key_index[compute_index].op_tag
        # 是reduce_last场景
        if compute_tag.endswith(t2c_util.REDUCE_LAST_KEYWORD):
            # 拿到已经采到的factor
            factor_index = ActionTensorCfg.split_factor_s + \
                           progress.todo.cache_layer * AXIS_CNT + \
                           progress.todo.axis_index
            # 获取已有factor
            factor = progress.action_tensor[stage_index][factor_index]
            # 拿到轴长
            curr_stage_nonzero_axes = progress.get_nonzero_axes(stage_index)
            reduce_axis_len = curr_stage_nonzero_axes[progress.todo.axis_index]
            # 最后一次采样是5的0次方乘以i,最终的切分因子是factor + i + 1
            for i in range(SEARCH_N):
                reduce_factor = factor + i
                # 切分因子是1或者尾块是1的地方mask掉
                if reduce_factor == 1 or reduce_axis_len % reduce_factor == 1:
                    action_mask[i] = 0
    log.dbg("r03 action_mask:%s", action_mask)

    return action_mask
