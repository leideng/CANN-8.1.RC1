#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.controller.mcts_search.procedure.action import ActionType
from schedule_search.controller.mcts_search.procedure.action import \
    SearcherAction
from schedule_search.ts_env.code_to_tensor.at_analysis import get_at_info
from schedule_search.controller.mcts_search.procedure.comm import \
    get_first_todo


def proc(progress):  # pylint: disable=R0912
    """

    :param progress:
    :return:
    """
    # 如果还有没采完的at_stage，先接着采
    stages_info = progress.op_schedule_info.stages_info
    for stage_index in range(len(stages_info) - 1, -1, -1):
        at_info = stages_info[stage_index].get('at_info', None)
        if not at_info:
            continue
        for consumer_id, consumer in enumerate(at_info.consumers):
            if len(consumer.at_candidates) > 1 \
                    and consumer.sampled_target is None:
                progress.todo = SearcherAction(
                    stage_index=stage_index,
                    action_type=ActionType.at_stage,
                    sub_action_index=consumer_id,
                )
                return

    # 如果都采完了，则按照采完的结果再次计算，是否还有需要采的at_stage
    get_at_info(progress.op_schedule_info)
    stages_info = progress.op_schedule_info.stages_info
    for stage_index in range(len(stages_info) - 1, -1, -1):
        at_info = stages_info[stage_index].get('at_info', None)
        for consumer_id, consumer in enumerate(at_info.consumers):
            if len(consumer.at_candidates) > 1 \
                    and consumer.sampled_target is None:
                progress.todo = SearcherAction(
                    stage_index=stage_index,
                    action_type=ActionType.at_stage,
                    sub_action_index=consumer_id,
                )
                return

    # 走出采样第一步
    get_first_todo(progress)
