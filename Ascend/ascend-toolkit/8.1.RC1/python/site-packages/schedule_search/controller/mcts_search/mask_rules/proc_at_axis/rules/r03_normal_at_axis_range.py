#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search import comm
from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.controller.mcts_search.procedure.comm import \
    need_search_at_axis


def proc(progress, action_mask):
    """
    规则内容：at_axis的范围为 轴数 × op_layers
    """
    stage_index = progress.todo.stage_index
    op_schedule_info = progress.op_schedule_info
    if op_schedule_info.c_op in comm.CONV_OP_ID_LIST:
        return action_mask

    if not need_search_at_axis(stage_index, op_schedule_info):
        return action_mask

    at_stage_index = progress.op_schedule_info.at_dict[stage_index]
    at_stage_nonzero_axes = progress.get_nonzero_axes(at_stage_index)
    op_layers = progress.op_layers
    at_axis_num = len(at_stage_nonzero_axes) * op_layers
    for idx in range(SEARCH_N):
        if idx >= at_axis_num:
            action_mask[idx] = 0

    # 不能全部都mask掉
    if sum(action_mask) == 0:
        action_mask[0] = 1

    log.dbg('r03_normal_at_axis_range: %s', action_mask)
    return action_mask
