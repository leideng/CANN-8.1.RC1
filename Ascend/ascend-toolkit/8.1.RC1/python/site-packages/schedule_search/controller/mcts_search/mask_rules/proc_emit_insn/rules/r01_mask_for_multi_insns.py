#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from numpy import ndarray

from schedule_search.controller.mcts_search.features import SEARCH_N
from schedule_search.controller.mcts_search.schedule import Progress
from schedule_search.cce_intrin_map import OP_INTRIN_KEY_TAG


def proc(progress: Progress, action_mask: ndarray) -> ndarray:
    """
    multi insn mask
    :param progress: Progress
    :param action_mask: action mask
    :return: action mask
    """
    stages = progress.op_schedule_info.schedule_obj.stages
    multi_intrins = []
    for stage in stages:
        if stage.op.tag in ["transpose"]:
            multi_intrins = OP_INTRIN_KEY_TAG[stage.op.tag].intrin.split('##')
            break

    for idx in range(SEARCH_N - 1, -1, -1):
        if idx >= len(multi_intrins):
            action_mask[idx] = 0
            continue

    if sum(action_mask) == 0:
        action_mask[0] = 1

    return action_mask
