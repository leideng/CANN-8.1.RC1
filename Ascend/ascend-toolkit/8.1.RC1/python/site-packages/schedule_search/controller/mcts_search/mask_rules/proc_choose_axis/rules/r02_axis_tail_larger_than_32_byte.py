#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env import env_util


def proc(progress, action_mask):
    """
    规则内容： 如果当前选择的轴及其之后的轴长乘积小于32//size(dtype)，
    则不能选这个轴切分
    """
    stages = progress.op_schedule_info.schedule_obj.stages
    last_stage = stages[len(stages) - 1]
    stage_dtype = last_stage.op.output(0).dtype
    block_size = env_util.get_block_num(stage_dtype)
    nonzero_axes = progress.get_nonzero_axes(progress.todo.stage_index)
    axis_num = len(nonzero_axes)
    total_size = 1
    # 如果导致尾块小于32byte，则不能选这个轴切分
    for idx in range(axis_num - 1, -1, -1):
        total_size *= nonzero_axes[idx]
        if total_size < block_size:
            action_mask[idx] = 0

    if sum(action_mask) == 0:
        action_mask[0] = 1

    log.dbg("r02 choose_axis:%s", action_mask)
    return action_mask
