#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search import comm
from schedule_search.ts_env.env_consts import MODE_RUNTIME
from schedule_search.ts_env.cheque_generator import get_buffer_align_cheque
from tbe.common.platform import CUBE_MKN


def proc(t2c_params):
    """

    :param t2c_params:
    :return:
    """
    stage = t2c_params.stage
    stage_name = t2c_params.stage_name
    stage_index = t2c_params.stage_index

    # 前面规则处理过的stage直接跳过
    if t2c_params.proc_flag_dict.get(stage_index, False):
        return True

    if t2c_params.op_schedule_info.c_op not in comm.CONV_OP_ID_LIST:
        return False

    if stage.op.tag not in [
            'dequant_vector', "requant_vector", "data_transfer",
            "dequant_s16_vector"
    ]:
        return True

    log.dbg("%s enable buffer_align", stage_name)

    block_m = CUBE_MKN[stage.op.output(0).dtype]["mac"][0]
    block_n = CUBE_MKN[stage.op.output(0).dtype]["mac"][2]
    args = "(1, 1), (1, 1), (1, %s), (1, %s)" % (block_m, block_n)
    code_line = 'sch[%s].buffer_align(%s)' % (stage_name, args)
    t2c_params.code_lines.append(code_line)
    align_list = [[1, 1], [1, 1], [1, block_m], [1, block_n]]
    # 生成buffer_align对应的cheque
    get_buffer_align_cheque(t2c_params, stage_index, align_list)
    if t2c_params.mode == MODE_RUNTIME:
        stage.buffer_align(*align_list)
    t2c_params.proc_flag_dict[stage_index] = True
    return True
