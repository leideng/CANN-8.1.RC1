#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env.env_consts import MODE_RUNTIME
from schedule_search.ts_env.cheque_generator import get_preload_cheque


def proc(t2c_params):
    """

    :param t2c_params:
    :return:
    """
    stage = t2c_params.stage
    stage_name = t2c_params.stage_name
    stage_index = t2c_params.stage_index

    # 前面规则处理过的stage直接跳过
    if t2c_params.proc_flag_dict.get(stage_index, False):
        return True
    fanout_list = t2c_params.op_schedule_info.real_fanout_dict[stage_index]
    if stage.op.name.endswith(".local.L0C") or (
            fanout_list and t2c_params.schedule.stages[
                fanout_list[0]].op.name.endswith(".local.L0C")):
        log.dbg("%s enable preload", stage_name)
        code_line = 'sch[%s].preload()' % stage_name
        t2c_params.code_lines.append(code_line)
        # 生成preload对应的cheque
        get_preload_cheque(t2c_params, stage_index)
        if t2c_params.mode == MODE_RUNTIME:
            stage.preload()
        t2c_params.proc_flag_dict[stage_index] = True

    return True
