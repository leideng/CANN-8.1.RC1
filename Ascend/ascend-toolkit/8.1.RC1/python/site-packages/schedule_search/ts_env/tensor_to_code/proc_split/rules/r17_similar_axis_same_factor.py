#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.timer import timer


@timer('r17')
def proc(t2c_params):  # pylint: disable=R0912
    """
    规则内容：类似轴保持同样的Factor，当前先特殊处理，只对cosine算子使能
    """
    if t2c_params.op_schedule_info.op_name not in ["cosine_embedding_loss"]:
        return

    reduce_stage_indexs = []
    workspace_stage_indexs = []
    reduce_factor = 0
    workspace_factor = 0
    for stage_index, _ in enumerate(t2c_params.schedule.stages):
        stage_info = t2c_params.stages_info[stage_index]
        # 先临时处理，后续完善，补充similar stage识别，即只有自身及其fanin的stage
        # shape和dtype都相同，并同步加到采样流程中去
        if "reduce" in stage_info.get('type', []):
            if len(reduce_stage_indexs) >= 3:
                continue
            reduce_factor = max(t2c_params.cleaned_actions[stage_index][0],
                                reduce_factor)
            reduce_stage_indexs.append(stage_index)
        elif "workspace" in stage_info.get('type', []):
            workspace_stage_indexs.append(stage_index)
            workspace_factor = max(t2c_params.cleaned_actions[stage_index][0],
                                   workspace_factor)

    log.dbg("reduce: %s, workspace: %s factor keep same!", reduce_stage_indexs,
            workspace_stage_indexs)
    for stage_index in reduce_stage_indexs:
        t2c_params.cleaned_actions[stage_index][0] = reduce_factor
    for stage_index in workspace_stage_indexs:
        t2c_params.cleaned_actions[stage_index][0] = workspace_factor
