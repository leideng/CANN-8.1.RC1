#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_to_code import t2c_util
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.timer import timer
from schedule_search import comm


@timer('r16')
def proc(t2c_params):
    '''
    规则内容：gemm的batch轴不能切
    '''
    # 输入
    sch = t2c_params.schedule
    c_op = t2c_params.op_schedule_info.c_op
    has_batch, _ = t2c_util.gemm_identify(t2c_params.op_schedule_info)
    if c_op not in comm.MAD_OP_ID_LIST or not has_batch:
        return

    axis_num = t2c_util.max_axis()
    stages_info = t2c_params.op_schedule_info.stages_info
    for stage_index, stage in enumerate(sch.stages):
        # reduce stage action中存储的是reduce axis的切分，没有batch轴不需要处理
        if 'placeholder' in stages_info[stage_index].get('type', []) or \
                stage_index in t2c_params.inlined_stages or \
                stage.op.reduce_axis:
            continue
        t2c_params.cleaned_actions[stage_index][
            ActionTensorCfg.split_factor_s] = 0
        t2c_params.cleaned_actions[stage_index][
            ActionTensorCfg.split_factor_s + axis_num] = 0
