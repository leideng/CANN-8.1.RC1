#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from tbe import tvm
from schedule_search.ts_env.tensor_to_code.proc_inline.rules.comm import \
    is_special_stage
from schedule_search.ts_env.depend import get_fanouts_from_sch


def is_output(t2c_params, stage_index):
    """
    check if next node is output
    """
    sch = t2c_params.schedule
    stages = sch.stages
    stage = stages[stage_index]
    stage_info = t2c_params.stages_info[stage_index]

    if stage_info.get('scope') == 'local.UB' and \
       'CacheWrite' in stage_info.get('type', []):
        fanout_list = get_fanouts_from_sch(sch, stage)
        next_stage = stages[fanout_list[0]]
        next_fanout_list = get_fanouts_from_sch(sch, next_stage)
        if not next_fanout_list:
            return False
        next_stage_info = t2c_params.stages_info[next_fanout_list[0]]
        tag = next_stage_info.get('tag', '')
        if tag.endswith('_cast') or tag == 'ub_to_out':
            return True
    return False


def proc(t2c_params, stage_index):
    """
    split与elementwise一起可以融合
    """
    stage = t2c_params.schedule.stages[stage_index]
    if stage.op.tag == "split_com" and \
       not isinstance(stage.op.input_tensors[0].op, tvm.PlaceholderOp):
        if is_output(t2c_params, stage_index):
            return False
        return True

    return False
