#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.env_consts import MODE_RUNTIME
from schedule_search.ts_env.cheque_generator import get_bind_cheque
from tbe import tvm


def proc(t2c_params):  # pylint: disable=R0912
    """

    :param t2c_params:
    :return:
    """
    stages_info = t2c_params.stages_info
    mode = t2c_params.mode
    # 对Co轴使能多核
    for stage, stage_index in t2c_params.bind_stages:

        # 前面规则处理过的stage直接跳过
        if t2c_params.proc_flag_dict.get(stage_index, False):
            continue

        stage_info = stages_info[stage_index]
        for axis_info in t2c_params.axis_info_list[stage_index]:
            if axis_info.sub_axis_split == "Co1":
                t2c_params.code_lines.append(
                    "block = tvm.te.thread_axis('blockIdx.x')")
                code_line = "sch[%s].bind(%s, block)" % (stage_info['name'],
                                                         axis_info.name)
                t2c_params.code_lines.append(code_line)
                t2c_params.proc_flag_dict[stage_index] = True

                if mode == MODE_RUNTIME:
                    block = tvm.te.thread_axis('blockIdx.x')
                    stage.bind(axis_info.body, block)
                # 生成bind操作对应的cheque
                get_bind_cheque(t2c_params, stage_index)

                break

    return True
