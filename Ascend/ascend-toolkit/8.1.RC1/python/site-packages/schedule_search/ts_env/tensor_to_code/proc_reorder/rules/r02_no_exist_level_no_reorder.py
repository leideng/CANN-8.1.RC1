#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.ts_env.tensor_to_code import t2c_util
from schedule_search.util import get_op_layers


def proc(t2c_params): # pylint: disable=R0912
    """
    规则内容：不存在的layer不进行reorder
    """
    # 输入
    sch = t2c_params.schedule
    op_layers = get_op_layers(sch)
    stage_num = len(t2c_params.cleaned_actions)
    axis_num = t2c_util.max_axis()
    factor_num = ActionTensorCfg.reorder_e + 1 - ActionTensorCfg.reorder_s
    if factor_num // axis_num > op_layers:
        for stage_index in range(stage_num):
            for i in range(factor_num // axis_num - op_layers):
                for j in range(axis_num):
                    factor_index = ActionTensorCfg.reorder_s + \
                                   (op_layers + i) *  axis_num + j
                    t2c_params.cleaned_actions[stage_index][factor_index] = j
