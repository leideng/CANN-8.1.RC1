#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_to_code import t2c_util
from schedule_search.timer import timer


@timer('r07')
def proc(t2c_params):  # pylint: disable=R0912
    """
    规则内容：不作为compute_at的reduce stage的切分因子为自身轴长
    """
    # 输入
    sch = t2c_params.schedule
    op_layers = t2c_params.op_layers
    for stage_index, stage in enumerate(sch.stages):
        # reduce_last场景
        if str(stage.op).startswith("placeholder") \
                or (not stage.op.reduce_axis):
            continue

        # 不在at_target_stages里面的reduce的stage，其reduce的切分因子置为其自身
        if stage_index in t2c_params.op_schedule_info.at_dict.values():
            continue

        for axis_index in range(len(stage.op.reduce_axis)):
            axis_num = t2c_util.max_axis()
            for buffer_depth in range(0, op_layers):
                factor_index = buffer_depth * axis_num + axis_index
                factor_in_actions = t2c_params.cleaned_actions[stage_index][
                    factor_index]
                if factor_in_actions == 0:
                    continue
                reduce_axis_len = stage.op.reduce_axis[
                    axis_index].dom.extent.value
                t2c_params.cleaned_actions[stage_index][factor_index] \
                    = reduce_axis_len
