#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import FeatureTensorCfg


def proc(t2c_params):  # pylint: disable=R0912
    """

    :param t2c_params:
    :return:
    """
    stage = t2c_params.stage
    stage_index = t2c_params.stage_index

    # 前面规则处理过的stage直接跳过
    if t2c_params.proc_flag_dict.get(stage_index, False):
        return True

    intrin = t2c_params.op_schedule_info.op_intrin_key_index[
        t2c_params.features[stage_index][FeatureTensorCfg.compute_s]].intrin
    if intrin == 'mad':
        t2c_params.proc_flag_dict[stage_index] = True
        return True

    if stage.op.name.endswith(".local.L0A") or stage.op.name.endswith(
            ".local.L0B") or stage.op.name.endswith(".local.L1"):
        t2c_params.proc_flag_dict[stage_index] = True
        return True

    fanin_list = t2c_params.op_schedule_info.all_fanin_dict[stage_index]
    for fanin_index in fanin_list:
        if t2c_params.op_schedule_info.op_intrin_key_index[
                t2c_params.features[fanin_index][
                    FeatureTensorCfg.compute_s]].intrin == 'mad':
            t2c_params.proc_flag_dict[stage_index] = True
            return True

    return True
