#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env.env_consts import MODE_RUNTIME
from schedule_search.ts_env.cheque_generator import get_double_buffer_cheque


def proc(t2c_params):
    """

    :param t2c_params:
    :return:
    """
    stage = t2c_params.stage
    stage_name = t2c_params.stage_name
    stage_index = t2c_params.stage_index
    if stage.op.name.endswith(".local.L1") \
            or stage.op.name.endswith(".local.L0A") \
            or stage.op.name.endswith(".local.L0B") \
            or stage.op.name.endswith(".local.L0C"):
        # allocate_at的stage不做double_buffer
        if stage_index in t2c_params.allocate_at_list:
            return True
        # tik里weight复用的stage不做double_buffer
        b_l1_index = t2c_params.cube_info_dict.get("matrix_bl1", [])
        if t2c_params.op_schedule_info.option.get(
                "bl1_not_at", False) and stage_index in b_l1_index:
            log.dbg("bl1_not_at:%s, stage_index:%s,%s, name:%s",
                    t2c_params.op_schedule_info.option.get("bl1_not_at"),
                    stage_index, b_l1_index, stage_name)
            return True
        log.dbg('double_buffer stage_name: %s, %s', stage_name, stage_index)
        code_line = 'sch[%s].double_buffer()' % stage_name
        t2c_params.code_lines.append(code_line)
        # 生成double_buffer对应的cheque
        get_double_buffer_cheque(t2c_params, stage_index)
        t2c_params.double_buffer_list.append(stage_name)

        if t2c_params.mode == MODE_RUNTIME:
            stage.double_buffer()
    return True
