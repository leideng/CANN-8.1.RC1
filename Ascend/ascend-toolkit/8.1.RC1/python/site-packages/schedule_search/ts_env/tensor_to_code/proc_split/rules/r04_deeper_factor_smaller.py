#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.ts_env.tensor_to_code import t2c_util
from schedule_search.timer import timer


@timer('r04')
def proc(t2c_params):
    """
    规则内容：深层次的Factor应小于其上一级Factor，否则将其置为等于上一级Factor
    """
    # 输入
    sch = t2c_params.schedule

    for stage_index in range(len(sch.stages)):
        factor_num = ActionTensorCfg.split_factor_e + 1
        factor_num -= ActionTensorCfg.split_factor_s
        axis_num = t2c_util.max_axis()
        for buffer_depth in range(1, factor_num // axis_num):
            for axis_index in range(axis_num):
                last_layer_factor_index \
                    = (buffer_depth - 1) * axis_num + axis_index
                factor_index = buffer_depth * axis_num + axis_index
                factor_in_actions = t2c_params.cleaned_actions[stage_index][
                    factor_index]
                last_layer_factor = t2c_params.cleaned_actions[stage_index][
                    last_layer_factor_index]
                t2c_params.cleaned_actions[stage_index][factor_index] \
                    = min(factor_in_actions, last_layer_factor)
