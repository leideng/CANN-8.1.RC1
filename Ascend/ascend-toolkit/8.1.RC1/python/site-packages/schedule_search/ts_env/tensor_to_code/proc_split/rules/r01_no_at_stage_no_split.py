#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.timer import timer


@timer('r01')
def proc(t2c_params):
    """
    规则内容：不被at的stage不切分
    """
    sch = t2c_params.schedule
    clean_actions = t2c_params.cleaned_actions

    log.dbg("at_dict: %s", t2c_params.op_schedule_info.at_dict)
    for stage_index in range(len(sch.stages)):
        # 不是被at的stage不需要split
        ated = stage_index in t2c_params.op_schedule_info.at_dict.values()
        if not ated:
            for j in range(ActionTensorCfg.split_factor_s,
                           ActionTensorCfg.split_factor_e + 1):
                clean_actions[stage_index][j] = 0
            log.dbg('Stage %d not be at, no split action will applied.',
                    stage_index)
