#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.op_cfg import TIK_TO_DSL_OP_LIST
from schedule_search.ts_env.tensor_to_code.proc_inline.rules.comm import \
    is_special_stage
from schedule_search.ts_env.tensor_to_code.t2c_util import T2cParams


def proc(t2c_params: T2cParams, stage_index: int) -> bool:
    """
    trs mid tensor inline
    """
    op_type = t2c_params.op_schedule_info.option.get('op_type')
    trs_reorder_flag = op_type in TIK_TO_DSL_OP_LIST.keys() and \
                       "trs_reorder_times" in TIK_TO_DSL_OP_LIST.get(op_type).keys()
    if not trs_reorder_flag:
        return False

    stage_info = t2c_params.stages_info[stage_index]
    # transpose算子的data_x.local.UB需要做inline
    if "CacheRead" in stage_info["type"]:
        return True

    # 特殊节点不需要inline
    if is_special_stage(t2c_params, stage_index):
        return False

    return False
