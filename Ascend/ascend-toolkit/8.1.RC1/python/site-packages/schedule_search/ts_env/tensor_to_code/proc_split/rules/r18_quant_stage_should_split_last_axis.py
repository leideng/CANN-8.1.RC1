#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.timer import timer
from schedule_search import log
from schedule_search import comm
import schedule_search.ts_env.tensor_to_code.t2c_util as t2c_util


@timer('r20')
def proc(t2c_params):
    '''
    规则内容：量化相关stage最后一根轴要切分16
    '''
    # 输入
    sch = t2c_params.schedule
    if t2c_params.op_schedule_info.c_op not in comm.CONV_OP_ID_LIST:
        return

    stages_info = t2c_params.stages_info
    for stage_index, stage in enumerate(sch.stages):
        stage_info = stages_info[stage_index]
        if stage_index in t2c_params.inlined_stages:
            continue
        stages_type = stage_info.get("type", [])
        if stage_info["tag"] in t2c_util.QUANT_SERIES_TAGS and \
                "CacheWrite" in stages_type:
            log.dbg("stage: %s need split last axis", stage_info["name"])
            axis_num = len(stage.op.axis)
            t2c_params.cleaned_actions[stage_index][
                ActionTensorCfg.split_factor_s + axis_num - 1] = 16
