#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env.cheque_generator import get_block_sync_cheque
from schedule_search import op_cfg


def no_need_block_sync(t2c_params, stage_index):  # pylint: disable=R0912
    """

    :param t2c_params:
    :param stage_index:
    :return:
    """
    if t2c_params.op_schedule_info.op_name not in op_cfg.TIK_SYNC_OP_LIST:
        return True

    if not t2c_params.bind_stages:
        return True

    if stage_index not in t2c_params.bind_axis:
        return True

    bind_axis = t2c_params.bind_axis[stage_index]
    if isinstance(bind_axis.index, list):
        if 1 not in bind_axis.index:
            return True
    else:
        if bind_axis.index != 1:
            return True

    return False


def proc(t2c_params):
    """

    :param t2c_params:
    :return:
    """
    stage_index = t2c_params.stage_index

    # 前面规则处理过的stage直接跳过
    if t2c_params.proc_flag_dict.get(stage_index, False):
        return True

    if no_need_block_sync(t2c_params, stage_index):
        return True

    stage_name = t2c_params.stage_name
    # 此处默认bind的肯定是0轴，block_sync就取下一根轴
    block_sync_axis_index = 1
    block_sync_axis = t2c_params.axis_info_list[stage_index][
        block_sync_axis_index]

    log.dbg("%s enable block_sync", stage_name)
    code_line = 'sch[%s].%s(%s, sync0[0], bottom=True)' % (
        stage_name, "wait_block_sync", block_sync_axis.name)
    t2c_params.code_lines.append(code_line)
    # 生成wait_block_sync对应的cheque
    get_block_sync_cheque(t2c_params,
                          stage_index,
                          "wait_block_sync",
                          block_sync_axis_index,
                          -1,
                          bottom=True)

    code_line = 'sch[%s].%s(%s, sync0[0], bottom=True)' % (
        stage_name, "set_block_sync", block_sync_axis.name)
    t2c_params.code_lines.append(code_line)
    # 生成set_block_sync对应的cheque
    get_block_sync_cheque(t2c_params,
                          stage_index,
                          "set_block_sync",
                          block_sync_axis_index,
                          -1,
                          bottom=True)

    # tik dsl算子可以不需要runtime操作
    t2c_params.proc_flag_dict[stage_index] = True

    return True
