#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_to_code.proc_inline.rules.comm import \
    is_special_stage
from schedule_search import log


def proc(t2c_params, stage_index): # pylint: disable=R0912
    """
    如果input_tensor中包含被cache_write成UB/L1/L0A/L0B/L0C的stage，
    则当前stage被inline
    """
    stage = t2c_params.schedule.stages[stage_index]

    # concat算子的concat.local.UB需要做inline
    if t2c_params.op_schedule_info.op_name == "concat":
        if 'concat' in stage.op.tag and '.local.' in stage.op.name:
            return True

    # l1_fusion,[addr_type]=1 或者[input_l1_flag]=1，inline掉tensor_a_l1
    l1_fusion_dict = t2c_params.op_schedule_info.l1_fusion_dict
    if stage.op.name == 'tensor_a_l1' and (
            l1_fusion_dict['in_addr_type'] == 1 or
            l1_fusion_dict['input_l1_flag'] == 1):
        log.dbg("l1_fusion [addr_type]=1 or [input_l1_flag]=1, "
                "inline tensor_a_l1")
        return True

    if '.local.' in stage.op.name:
        return False

    for input_tensor in stage.op.input_tensors:
        # 经过cache read或write过的stage不需要做inline，否则就不需要做cache操作
        if '.local.' in input_tensor.op.name:
            return True

    return False
