#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.op_cfg import TIK_TO_DSL_OP_LIST
from schedule_search.ts_env.tensor_cfg import AXIS_CNT
from schedule_search.ts_env.tensor_to_code.t2c_util import T2cParams


def get_nonzero_axes(t2c_params: T2cParams) -> list:
    """
    get nonzero_axes
    :param t2c_params:
    :return:
    """
    stage_fea = t2c_params.op_schedule_info.feature_tensor[-1]
    axis_list = stage_fea[:AXIS_CNT]
    nonzero_axes = [dim for dim in axis_list if dim > 0]

    return nonzero_axes


def update_chosen_axes(t2c_params: T2cParams, sorted_chosen_axes: list) -> list:
    """
    update chosen axes
    :param t2c_params:
    :param sorted_chosen_axes:
    :return:
    """
    # get nonzero axes
    nonzero_axes = get_nonzero_axes(t2c_params)

    split_factor_info = t2c_params.stages_info[-1]["trs_params"]["split_factor_info"]
    part_split_axis_index = None
    for axis_index in reversed(sorted_chosen_axes):
        if split_factor_info[axis_index] != 1 and \
                split_factor_info[axis_index] != nonzero_axes[axis_index]:
            part_split_axis_index = axis_index
            break

    # 部分切分轴前的切分轴等于shape值时, 则不作为切分轴用于后续的计算
    updated_axes = sorted_chosen_axes
    if part_split_axis_index is not None:
        for axis_index in sorted_chosen_axes:
            if axis_index < part_split_axis_index and \
                    split_factor_info[axis_index] == nonzero_axes[axis_index]:
                updated_axes.remove(axis_index)
    return updated_axes


def calc_trs_split_axis(t2c_params: T2cParams, chosen_axes: list) -> (int, int):
    """
    calculate trs split axis for input and output
    :param chosen_axes:
    :return:
    """
    sorted_chosen_axes = sorted(set(chosen_axes))

    # update chosen_axes
    sorted_chosen_axes = update_chosen_axes(t2c_params, sorted_chosen_axes)

    split_times = TIK_TO_DSL_OP_LIST.get(t2c_params.op_schedule_info.option.get('op_type')).get("split_times", 1)

    split_axis_for_input = -1
    split_axis_for_output = -1
    if len(sorted_chosen_axes) in range(0, split_times + 1):
        split_axis_for_input = sorted_chosen_axes[0]
        split_axis_for_output = sorted_chosen_axes[-1]
    else:
        log.warn('chosen axes num is not correct for tik_to_dsl_op.')

    return split_axis_for_input, split_axis_for_output


def calc_trs_reorder_action(t2c_params: T2cParams) -> (list, list):
    """
    calculate trs reorder action
    :param t2c_params:
    :return:
    """
    # for trs reorder optimize, only last stage exist trs_reorder_action
    last_stage_info = t2c_params.stages_info[-1]
    input_reorder_action = last_stage_info["trs_params"]["input_reorder_action"]
    output_reorder_action = last_stage_info["trs_params"]["output_reorder_action"]

    # get nonzero axes
    nonzero_axes = get_nonzero_axes(t2c_params)

    # get axis info
    input_reorder_action = input_reorder_action[:len(nonzero_axes)]
    output_reorder_action = output_reorder_action[:len(nonzero_axes)]

    return input_reorder_action, output_reorder_action
