#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.timer import timer
from schedule_search.ts_env.tensor_cfg import FeatureTensorCfg


@timer('r18')
def proc(t2c_params):
    '''
    规则内容：Conv融合的大K不切
    '''
    # 输入
    sch = t2c_params.schedule
    features = t2c_params.features
    op_schedule_info = t2c_params.op_schedule_info
    if op_schedule_info.c_op != "conv_deep_fuse":
        return

    for stage_index, _ in enumerate(sch.stages):
        compute = features[stage_index][FeatureTensorCfg.compute_s]
        intrin = op_schedule_info.op_intrin_key_index[compute].intrin
        if intrin == 'mad':
            axis_len = sch.stages[stage_index].op.reduce_axis[
                0].dom.extent.value
            t2c_params.cleaned_actions[stage_index][
                ActionTensorCfg.split_factor_s] = axis_len
