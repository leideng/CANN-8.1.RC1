#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search import comm


def proc(t2c_params, stage_index):
    """
    # 不涉及padding的conv需要对remove_pad stage做inline
    """
    if t2c_params.op_schedule_info.c_op not in comm.CONV_OP_ID_LIST:
        return False

    stages_info = t2c_params.stages_info
    if stages_info[stage_index]["tag"] != 'remove_pad':
        return False

    stages = t2c_params.schedule.stages

    nearest_set_fmatrix = None
    for i in range(stage_index, -1, -1):
        stage_info = stages_info[i]
        if stage_info["tag"] == "set_fmatrix":
            nearest_set_fmatrix = i
            break

    if nearest_set_fmatrix is None:
        return False

    conv_params = stages[nearest_set_fmatrix].op.attrs
    padding = conv_params['conv_padding_top'] + conv_params[
                'conv_padding_bottom'] + conv_params[
                    'conv_padding_left'] + conv_params['conv_padding_right']
    if padding.value:
        return False
    log.dbg("stage_info: %s need inline", stages_info[stage_index]["name"])
    return True
