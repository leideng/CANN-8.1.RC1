#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.ts_env.tensor_cfg import FeatureTensorCfg
from schedule_search.ts_env.tensor_to_code import t2c_util


def proc(t2c_params):  # pylint: disable=R0912
    """
    规则内容：切reduce stage的非reduce轴，需要把reduce轴都放在最后
    """
    features = t2c_params.features
    axis_num = t2c_util.max_axis()
    reorder_len = ActionTensorCfg.reorder_e + 1 - ActionTensorCfg.reorder_s
    layer_num = reorder_len // axis_num

    for stage_index, stage_info in enumerate(
            t2c_params.op_schedule_info.stages_info):
        compute = features[stage_index][FeatureTensorCfg.compute_s]
        tag = t2c_params.op_schedule_info.op_intrin_key_index[compute].op_tag
        # 只有reduce last才会切普通轴
        if 'last' not in tag:
            continue

        # reduce stage没切
        if not t2c_params.axis_info_list[stage_index]:
            continue

        # 没切普通轴
        split_axis_type = stage_info.get('split_axis_type', None)
        if split_axis_type != 'axis':
            continue

        axes_num = len(t2c_params.leveled_axis_for_reorder[stage_index])
        for layer_index in range(layer_num, axes_num):
            leveled_axis = t2c_params.leveled_axis_for_reorder[stage_index][
                layer_index]
            leveled_reduce_axis = [
                x
                for x in leveled_axis
                if '_reduce_axis_' in x.name
            ]
            # 只要reduce轴
            releveled_axis = leveled_reduce_axis
            t2c_params.leveled_axis_for_reorder[stage_index][layer_index] \
                = releveled_axis
