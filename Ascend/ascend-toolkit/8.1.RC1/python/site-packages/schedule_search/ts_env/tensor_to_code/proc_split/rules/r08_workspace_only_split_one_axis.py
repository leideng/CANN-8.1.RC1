#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env.tensor_to_code import t2c_util
from schedule_search.timer import timer


@timer('r08')
def proc(t2c_params): # pylint: disable=R0912
    '''
    规则内容：workspace节点at到别的stage时，at轴之后的轴不允许切分
    '''

    sch = t2c_params.schedule
    stages_info = t2c_params.stages_info
    stages = list(sch.stages)

    for stage_index, stage in enumerate(stages):
        stage_info = stages_info[stage_index]
        if "workspace" not in stage_info.get('type', []):
            continue
        at_target_index = t2c_params.op_schedule_info.at_dict[stage_index]
        split_axis = t2c_util.get_split_axis(t2c_params, stage_index)
        at_split_axis = t2c_util.get_split_axis(t2c_params, at_target_index)

        # 中间如果有reduce/broadcast stage，导致这里的split_axis
        # 和at_split_axis就不是正好对应的关系，没有可比性，不处理
        stage_shape = [
            shape_item.value
            for shape_item in stage.op.output(0).shape
        ]
        at_stage_shape = [
            shape_item.value
            for shape_item in stages[at_target_index].op.output(0).shape
        ]
        if stage_shape != at_stage_shape:
            continue

        if split_axis == at_split_axis:
            continue

        # 将workspace节点at_split_axis之后的factor都clean成轴长
        for i, shape_item in enumerate(stage.op.output(0).shape):
            if i <= at_split_axis:
                continue
            t2c_params.cleaned_actions[stage_index][i] = shape_item.value
            log.dbg("stage_index: %s, clean axis %s", stage_index, i)
