#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_cfg import ActionTensorCfg
from schedule_search.timer import timer


def proc_broadcast_nist(t2c_params):
    """
    proc_broadcast_nist
    :param t2c_params:
    :return:
    """
    # 最后一根broadcast轴之后的所有普通轴是32b对齐的，不处理
    is_align = t2c_params.op_schedule_info.broadcast_dict['is_align']
    if is_align:
        return True

    # 有一些特殊的broadcast不需要处理
    special_broadcast \
        = t2c_params.op_schedule_info.broadcast_dict['special_broadcast']
    if special_broadcast:
        return True

    # # 进行clean，最后一根broadcast轴之前的轴factor为1
    max_last_broadcast_axis \
        = t2c_params.op_schedule_info.broadcast_dict['max_axis']
    for axis_index in range(max_last_broadcast_axis + 1):
        t2c_params.cleaned_actions[-1][ActionTensorCfg.split_factor_s +
                                       axis_index] = 1
    return True


@timer('r14')
def proc(t2c_params):  # pylint: disable=R0912
    """
    规则内容：
    1）算子只包含broadcast_last，且不仅broadcast最后一根轴，还broadcast了非最后一根轴
    则只能切最后一根非broadcast轴之后的broadcast轴
    2）算子只包含broadcast_nist，且最后一根broadcast轴之后的所有普通轴不是32b对齐的，
    则只能切最后一根broadcast轴之后的普通轴
    """
    # 多输出不处理
    if len(t2c_params.op_schedule_info.output_info_list) > 1:
        return True

    broadcast_type = t2c_params.op_schedule_info.broadcast_dict.get(
        'type', None)
    # 1、只有broadcast_last tensor, 且所有的都只broadcast了最后一根轴，不处理
    if broadcast_type == 'last_without_nist':
        return True

    # 2、只有broadcast_last tensor, 但有的不仅broadcast最后一根轴，
    # 还broadcast了非最后一根轴，
    # 只能切最后一根非broadcast轴之后的broadcast轴
    if broadcast_type == 'last_with_nist':
        # 进行clean，最后一根非broadcast轴之前的轴factor为1
        max_last_none_broadcast_axis \
            = t2c_params.op_schedule_info.broadcast_dict['max_axis']
        for axis_index in range(max_last_none_broadcast_axis + 1):
            t2c_params.cleaned_actions[-1][ActionTensorCfg.split_factor_s +
                                           axis_index] = 1
        return True

    # 3、只有broadcast_nist tensor，只能切最后一根broadcast轴之后的非broadcast轴
    if broadcast_type == 'nist':
        return proc_broadcast_nist(t2c_params)

    # 4、没有broadcast，不处理
    return True
