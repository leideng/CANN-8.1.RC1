#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.ts_env.tensor_to_code.atomic_comm import gen_split_info
from schedule_search.ts_env.cheque_generator import get_split_cheque
from schedule_search.timer import timer


@timer()
def do_block_tiling(t2c_params,
                    code_lines,
                    reduce_stage_index,
                    block_split_info):
    """
    进行多核切分
    """
    stage = t2c_params.schedule.stages[reduce_stage_index]
    stage_name = t2c_params.stages_info[reduce_stage_index].get('name')
    outer_axis_name = '%s_o' % block_split_info.axis_name
    inner_axis_name = '%s_i' % block_split_info.axis_name
    code_lines.append(
        '%s, %s = sch[%s].split(sch[%s].op.reduce_axis[%d], factor=%d)' %
        (outer_axis_name,
         inner_axis_name,
         stage_name,
         stage_name,
         block_split_info.axis_index,
         block_split_info.factor))
    log.dbg('block_split_info: %s', block_split_info)

    # 即使offline模式也需要进行实 际的操作
    block_split_axis_obj_o, block_split_axis_obj_i = \
        stage.split(block_split_info.axis_obj, factor=block_split_info.factor)

    # 更新split_info
    block_split_info = gen_split_info(block_split_info,
                                      outer_axis_name=outer_axis_name,
                                      outer_axis_obj=block_split_axis_obj_o,
                                      inner_axis_name=inner_axis_name,
                                      inner_axis_obj=block_split_axis_obj_i)

    # 生成对应的cheque
    get_split_cheque(t2c_params, reduce_stage_index,
                     block_split_info.axis_index, block_split_info.factor)

    return block_split_info


@timer()
def do_ub_tiling(t2c_params, # pylint: disable=R0914
                 code_lines,
                 rfactor_stage_index,
                 block_split_axis_index,
                 ub_split_info):
    '''
    ub切分处理
    '''
    # py记录一下ub_split_axis_type
    ub_split_axis_type = t2c_params.stages_info[rfactor_stage_index + 1].get(
        'split_axis_type', 'reduce_axis')
    code_lines.append('# split_axis_type: %s' % ub_split_axis_type)

    # 对应的axis已经在block切分时被split，直接切inner轴即可
    # 因为rfactor时factor_axis为-1，inner轴为rfactor stage的最后一个reduce_axis
    rfactor_stage = t2c_params.schedule.stages[rfactor_stage_index]
    rfactor_stage_name = t2c_params.stages_info[rfactor_stage_index].get(
        'name')
    if ub_split_axis_type != 'axis' \
        and block_split_axis_index == ub_split_info.axis_index:
        ub_split_info = \
            gen_split_info(ub_split_info,
                           axis_name='sch[%s].op.reduce_axis[%s]' % (
                               rfactor_stage_name,
                               len(rfactor_stage.op.reduce_axis) - 1),
                           axis_obj=rfactor_stage.op.reduce_axis[
                               len(rfactor_stage.op.reduce_axis) - 1])

    prefix = 'axis' if ub_split_axis_type == 'axis' else 'reduce_axis'
    rfactor_split_axis_name = '%s_%s' % (rfactor_stage_name, prefix)
    code_lines.append(
        '%s_o, %s_i = sch[%s].split(%s, factor=%d)' %
        (rfactor_split_axis_name, rfactor_split_axis_name, rfactor_stage_name,
         ub_split_info.axis_name, ub_split_info.factor))

    # run time
    ub_split_axis_obj_o, ub_split_axis_obj_i = \
        rfactor_stage.split(ub_split_info.axis_obj,
                            factor=ub_split_info.factor)
    ub_split_info = \
        gen_split_info(ub_split_info,
                       outer_axis_name='%s_o' % rfactor_split_axis_name,
                       outer_axis_obj=ub_split_axis_obj_o,
                       inner_axis_name='%s_i' % rfactor_split_axis_name,
                       inner_axis_obj=ub_split_axis_obj_i)

    # 生成cheque，根据实际切分轴的对象ub_split_axis_obj获取当前stage的切分轴
    get_split_cheque(t2c_params, rfactor_stage_index, block_split_axis_index,
                     ub_split_info.factor)

    return ub_split_info
