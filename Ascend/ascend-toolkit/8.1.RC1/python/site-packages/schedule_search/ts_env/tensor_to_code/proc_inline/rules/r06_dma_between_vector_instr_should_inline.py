#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_to_code.proc_inline.rules.\
    comm import get_real_fanin_fanout
from schedule_search import log
from schedule_search import comm
from schedule_search.cce_intrin_map import OP_INTRIN_KEY_TAG


def proc(t2c_params, stage_index):
    """
    如果当前stage是dma，且其父子stage均为vector指令，则该dma可以直接inline
    """
    # 通用规则，但为了减小影响范围，暂时只针对conv使能
    if t2c_params.op_schedule_info.c_op not in comm.CONV_OP_ID_LIST:
        return False

    stages_info = t2c_params.stages_info
    if "CacheWrite" not in stages_info[stage_index].get("type", []):
        return False

    intrin = OP_INTRIN_KEY_TAG[stages_info[stage_index]["tag"]].intrin
    if intrin != 'dma_copy':
        return False

    sch = t2c_params.schedule
    fanin_list, fanout_list = get_real_fanin_fanout(sch, stage_index)
    if not fanin_list or not fanout_list:
        return False

    fanout_intrin = OP_INTRIN_KEY_TAG[stages_info[fanout_list[0]]
                                      ["tag"]].intrin
    fanin_intrin = OP_INTRIN_KEY_TAG[stages_info[fanin_list[0]]["tag"]].intrin

    if fanout_intrin.startswith("vector_") and fanin_intrin.startswith(
            "vector_"):
        log.dbg("curr name: %s, fanin name: %s, fanout name: %s",
                stages_info[stage_index]["name"],
                stages_info[fanin_list[0]]["name"],
                stages_info[fanout_list[0]]["name"])
        return True

    return False
