#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search import log
from schedule_search.timer import timer
from schedule_search.ts_env.env_consts import MODE_RUNTIME
from schedule_search.ts_env.cheque_generator import get_reuseby_cheque


@timer('reuse')
def proc(t2c_params, rules):  # pylint: disable=R0914
    """

    :param t2c_params:
    :param rules:
    :return:
    """
    sch = t2c_params.schedule
    mode = t2c_params.mode
    code_lines = t2c_params.code_lines
    stages_info = t2c_params.stages_info
    stages = list(sch.stages)

    code_lines.extend(['\n', '# reuse code'])

    # 调用各个Rule，获取reuse_dict
    reuse_dict = {}
    for rule in rules:
        module = __import__(rule, fromlist=['1'])
        module.proc(t2c_params, reuse_dict)

    for src_buffer, dst_buffer in reuse_dict.items():
        src_stage = sch[src_buffer]
        src_stage_index = stages.index(src_stage)
        src_stage_name = stages_info[src_stage_index]["name"]
        dst_stage = sch[dst_buffer]
        dst_stage_index = stages.index(dst_stage)
        dst_stage_name = stages_info[dst_stage_index]["name"]
        code_line = 'sch[%s].reused_by(%s)' % (src_stage_name, dst_stage_name)
        code_lines.append(code_line)
        get_reuseby_cheque(t2c_params, src_stage_index, dst_stage_index)

        if mode == MODE_RUNTIME:
            src_stage.reused_by(dst_buffer)

    t2c_params.code_lines = code_lines

    log.dbg('reuse done')
    return True
