#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from schedule_search.ts_env.tensor_to_code import t2c_util


def proc(t2c_params):
    """
    规则内容：直接按axis_info_list中的顺序reorder
    1、reduce_atomic cache_write,
        普通轴：(ak,..a2,a1)
        reduce轴：(rbo_fused)
        reorder顺序：(rbo_fused,ak,..a2,a1)
    2、rfactor
        普通轴：(ak,..a2,a1,rbo_fused)
        reduce轴：(rb-1,.. ,(ruo,rui),..,r2,r1,rbi))
        reorder顺序：(rbo_fused,rbi,rb-1,..,r1,ak,..,a1)
    """
    tiling_case = t2c_params.op_schedule_info.tiling_case
    if tiling_case == 0:
        return True

    for stage_index, stage_axis_list in enumerate(t2c_params.axis_info_list):
        if not stage_axis_list:
            continue
        stage_info = t2c_params.stages_info[stage_index]
        if not (set(stage_info.get('type', []))
                & {'reduce_atomic_rfactor', 'reduce_atomic_write'}):
            continue
        t2c_params.leveled_axis_for_reorder[stage_index] \
            = [[], [], [], [], [], [], []]
        t2c_params.leveled_axis_for_reorder[stage_index][
            t2c_util.AXIS_LEVEL_OO_INDEX] = stage_axis_list
    return True
