#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
import time

from schedule_search import log
from schedule_search import util

BG_MODULES = [
    'schedule_search.backgroud.bank_update',
]


def bg_main(*args, **kwargs):
    """
    :param args:
    :param kwargs:
    :return:
    """
    option = args[1]
    interval = option.get('bank_update_interval', 30)
    if kwargs.get('bank_update_interval') == 0:
        interval = 0

    main_pid = option.get("main_pid", None)

    start_time = time.time()
    last_time = time.time()
    while True:
        if time.time() - last_time < interval:
            continue
        last_time = time.time()

        for module_name in BG_MODULES:
            log.dbg('module_name:%s', module_name)
            module = __import__(module_name, fromlist=['1'])
            func = getattr(module, 'proc')
            func(args, start_time)

        if kwargs.get('run_once', False):
            break

        if main_pid and not util.pid_exists(main_pid):
            log.info("main_pid:%s is dead!", main_pid)
            break
