#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
import multiprocessing


# BEST_CHEQUE_DICT is a shared dict: key=pid, value=list of dict with keys best_tick, base_tick, bank_key, cheque
BEST_CHEQUE_DICT = {}
# ACTION_HISTORY_DICT is a shared dict: key=op_md5, value=dict of action_md5: [hit_res, tick, hit_num]
ACTION_HISTORY_DICT = {}
# BEST_TICK_DICT is a shared dict: key=op_md5, value=best_tick
BEST_TICK_DICT = {}
# HISTORY_DICT is a shared dict: key=op_md5@cheque_md5, value=tick
CHEQUE_HISTORY_DICT = {}


class MultiprocessManager:
    """
    multiprocessing manager
    """
    def __init__(self) -> None:
        self.multi_mgr = multiprocessing.Manager()

    @staticmethod
    def clear_shared_dict() -> None:
        """
        clear shared dict
        """
        global BEST_CHEQUE_DICT
        global ACTION_HISTORY_DICT
        global CHEQUE_HISTORY_DICT
        global BEST_TICK_DICT

        BEST_CHEQUE_DICT.clear()
        ACTION_HISTORY_DICT.clear()
        CHEQUE_HISTORY_DICT.clear()
        BEST_TICK_DICT.clear()

    def init_shared_dict(self) -> None:
        """
        initialize shared dict
        """
        global BEST_CHEQUE_DICT
        global ACTION_HISTORY_DICT
        global CHEQUE_HISTORY_DICT
        global BEST_TICK_DICT

        BEST_CHEQUE_DICT = self.multi_mgr.dict()
        ACTION_HISTORY_DICT = self.multi_mgr.dict()
        CHEQUE_HISTORY_DICT = self.multi_mgr.dict()
        BEST_TICK_DICT = self.multi_mgr.dict()

    def shutdown(self) -> None:
        """
        close multiprocessing.Manager
        """
        global BEST_CHEQUE_DICT
        global ACTION_HISTORY_DICT
        global CHEQUE_HISTORY_DICT
        global BEST_TICK_DICT

        BEST_CHEQUE_DICT = {}
        ACTION_HISTORY_DICT = {}
        CHEQUE_HISTORY_DICT = {}
        BEST_TICK_DICT = {}

        self.multi_mgr.shutdown()
