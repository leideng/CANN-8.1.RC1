#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common apply action
"""
from auto_search.solution_space.tensor_cfg import get_init_action_tensor_zero
from auto_search.solution_space.action import apply_action_register
from auto_search.solution_space.action import PrepareActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space import tvm_compute as \
    tvm_compute_to_tensor


@apply_action_register(
    [ComputePattern.ELEMENTWISE, ComputePattern.REDUCE, ComputePattern.BROADCAST, ComputePattern.NORM,
     ComputePattern.TRANSPOSE, ComputePattern.POOLING, ComputePattern.TUPLE_REDUCE],
    PrepareActionType.UPDATE_PROGRESS)
def apply(progress):
    """
    update progress action
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    sch = op_schedule_info.schedule_obj
    stages_info = op_schedule_info.stages_info

    new_feature_tensor, new_reduce_axis_dict \
        = tvm_compute_to_tensor.proc(sch, stages_info,
                                     op_schedule_info.op_name)

    op_schedule_info.feature_tensor = new_feature_tensor
    op_schedule_info.reduce_axis_dict = new_reduce_axis_dict
    op_schedule_info.update_stages_info()

    op_schedule_info.update_worksapce_list()
    op_schedule_info.update_at_dict()
    op_schedule_info.update_dependency_dict()

    progress.action_tensor = get_init_action_tensor_zero(progress.stage_num)
