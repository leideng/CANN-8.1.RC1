#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
transpose compute at
"""
from __future__ import absolute_import

from auto_search.utils import logger
from auto_search.solution_space.tensor_cfg import ActionTensorCfg
from auto_search.solution_space.tensor_cfg import INVALID_AT_AXIS
from auto_search.solution_space.schedule_action.at.apply_action.rules.comm import get_my_at_target
from auto_search.solution_space.schedule_action.at.apply_action.rules.comm import get_at_choices_from_axis_info
from auto_search.solution_space.schedule_action.at.apply_action.rules.comm import clean_align_at
from auto_search.solution_space.schedule_action.at.apply_action.rules.comm import get_max_offset


def _get_at_axis(stage_index,  op_schedule_info):
    """
    get stage_at axis_index
    :param stage_index:
    :param op_schedule_info:
    :return:
    """
    at_dict = op_schedule_info.at_dict
    at_index = at_dict[stage_index]

    ori_cut_index = op_schedule_info.cut_axis_index[at_index]

    if op_schedule_info.last_cut_axis_index.get(at_index, None) is not None:
        return op_schedule_info.last_cut_axis_index[at_index]

    return ori_cut_index


def _ensure_at(progress, reversed_stages, at_dict, at_targets):
    """

    :param t2c_params:
    :param reversed_stages:
    :param at_dict:
    :param at_targets:
    :return:
    """
    stage_num = len(reversed_stages)
    for reverse_index, stage in enumerate(reversed_stages):
        stage_index = stage_num - reverse_index - 1
        at_stage_index = at_dict.get(stage_index)
        if at_stage_index is None:
            progress.action_tensor[stage_index][ActionTensorCfg.at_s] = \
                INVALID_AT_AXIS
            continue

        if str(stage.op).startswith("placeholder"):
            progress.action_tensor[stage_index][ActionTensorCfg.at_s] = \
                INVALID_AT_AXIS
            continue

        at_axis = _get_at_axis(stage_index, progress.op_schedule_info)
        logger.debug(
            'stage_index:%s, stage_name:%s, \
                at_axis:%s', stage_index, stage.op.name, at_axis)

        clean_at = clean_align_at(stage_index, at_axis, progress)
        progress.action_tensor[stage_index][
            ActionTensorCfg.at_s] = clean_at

        at_targets[stage_index] = clean_at


def _ensure_at_axis(progress, reversed_stages, at_dict, at_targets):
    """

    :param progress:
    :param reversed_stages:
    :param at_dict:
    :param at_targets:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    stage_num = len(reversed_stages)
    axis_info_list = op_schedule_info.axis_info_list
    for reverse_index in range(stage_num):
        stage_index = stage_num - reverse_index - 1
        clean_at = progress.action_tensor[stage_index][
            ActionTensorCfg.at_s]

        if clean_at == INVALID_AT_AXIS:
            at_targets[stage_index] = None
            continue

        at_stage_index = at_dict[stage_index]
        my_at_choices = get_at_choices_from_axis_info(
            axis_info_list[at_stage_index])
        at_choice_index = clean_at if clean_at != -1 else 0

        if at_choice_index > len(my_at_choices) - 1:
            at_choice_index = len(my_at_choices) - 1

        max_offset = get_max_offset(progress, my_at_choices, at_choice_index, at_targets, stage_index)
        at_choices = my_at_choices[at_choice_index][:max_offset + 1]

        at_targets[stage_index] = get_my_at_target(at_choices)


def proc(progress):
    """
    transpose compute at rule
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    sch = op_schedule_info.schedule_obj
    features = op_schedule_info.feature_tensor
    at_dict = op_schedule_info.at_dict
    stage_num = len(features)
    at_choices = []
    for _ in range(stage_num):
        at_choices.append([])

    at_targets = [None] * stage_num
    reversed_stages = list(sch.stages)
    reversed_stages.reverse()

    _ensure_at(progress, reversed_stages, at_dict, at_targets)

    _ensure_at_axis(progress, reversed_stages, at_dict, at_targets)

    op_schedule_info.at_targets = at_targets
    return True
