#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
rlast other stage axis
"""
from auto_search.solution_space.tensor_cfg import FeatureTensorCfg
from auto_search.solution_space.schedule_action.emit_insn.apply_action.rules.comm import \
    get_emit_insn_axis
from auto_search.bank.cheque_generator import get_emit_insn_cheque


def proc(progress):
    """
    proc
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    features = op_schedule_info.feature_tensor
    stage_index = op_schedule_info.stage_index
    stage_name = op_schedule_info.stage_name
    stage = op_schedule_info.stage

    if op_schedule_info.proc_flag_dict.get(stage_index, False):
        return True

    if op_schedule_info.stages_info[stage_index].get("force_phony_insn", False):
        intrinsic_func_name = "phony_insn"
    else:
        intrinsic_func_name = op_schedule_info.op_intrin_key_index[
            features[stage_index][FeatureTensorCfg.compute_s]].intrin
        intrinsic_func_name = _get_pad_intrin(intrinsic_func_name, op_schedule_info, stage_index)

    insn_axis_idx, emit_insn_axis, emit_insn_axis_obj = get_emit_insn_axis(
        stage,
        stage_index,
        op_schedule_info.axis_info_list,
        op_schedule_info.stages_info[stage_index])

    code_line = "sch[{}].emit_insn({}, '{}')".format(stage_name, emit_insn_axis, intrinsic_func_name)
    op_schedule_info.code_lines.append(code_line)

    stage.emit_insn(emit_insn_axis_obj, intrinsic_func_name)

    # gen emit_insn cheque
    cheque = get_emit_insn_cheque(stage_index, intrinsic_func_name, (emit_insn_axis, insn_axis_idx))
    op_schedule_info.cheque_list.append(cheque)

    op_schedule_info.proc_flag_dict[stage_index] = True
    return True


def _get_pad_intrin(intrin, op_schedule_info, stage_index):
    """
    :param intrin:
    :param op_schedule_info:
    :param stage_index:
    :return:
    """
    if 'align_pad' in op_schedule_info.stages_info[stage_index].get('type', []):
        intrin = 'align_pad'
    elif 'remove_pad' in op_schedule_info.stages_info[stage_index].get('type', []):
        intrin = 'remove_pad'
    elif 'broadcast_remove_pad' in op_schedule_info.stages_info[stage_index].get('type', []):
        intrin = 'vector_reduce'
    return intrin
