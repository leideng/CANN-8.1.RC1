#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common apply action
"""
import importlib

from auto_search.utils import logger
from auto_search.solution_space.action import apply_action_register
from auto_search.solution_space.action import ScheduleActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.schedule_action.utils import get_schedule_action_rules
from auto_search.solution_space.progress import Progress


@apply_action_register(
    [ComputePattern.ELEMENTWISE, ComputePattern.BROADCAST, ComputePattern.REDUCE, ComputePattern.NORM,
     ComputePattern.TRANSPOSE, ComputePattern.POOLING, ComputePattern.TUPLE_REDUCE],
    ScheduleActionType.BUILD_CONFIG)
def apply(progress: Progress) -> bool:
    """
    :param progress:
    :return:
    """
    op_pattern = progress.op_schedule_info.op_pattern
    rules = get_schedule_action_rules(op_pattern, "proc_build_config")
    op_schedule_info = progress.op_schedule_info

    for rule in rules:
        module = importlib.import_module(rule)
        ret = module.proc(progress)
        if not ret:
            logger.error('mask proc failed. %s', module)
            return False

    # The complete cheque information is also placed in codelines and stored in the py file
    op_schedule_info.code_lines.append('')
    op_schedule_info.code_lines.append('# cheque_list: %s' % op_schedule_info.cheque_list)

    logger.debug("apply build config done.")
    return True
