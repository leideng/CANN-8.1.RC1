#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common director
"""
from typing import NoReturn

from auto_search.solution_space.action import director_register
from auto_search.solution_space.action import ScheduleActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.schedule_action.reuse.reuse_action \
    import ReuseAction
from auto_search.solution_space.schedule_action.emit_insn.emit_insn_action \
    import EmitInsnAction
from auto_search.solution_space.search_action.ub_transpose.ub_transpose_action import UbTransposeAction
from auto_search.compute_analysis import support_ub_transpose_search
from auto_search.solution_space.progress import Progress


@director_register([ComputePattern.NORM, ComputePattern.BROADCAST, ComputePattern.ELEMENTWISE],
                   ScheduleActionType.DOUBLE_BUFFER)
def direct(progress: Progress) -> NoReturn:
    """
    :param progress:
    :return:
    """
    pattern = progress.op_schedule_info.op_pattern
    next_todo = ReuseAction(pattern)
    progress.todo = next_todo


@director_register([ComputePattern.TRANSPOSE, ComputePattern.POOLING], ScheduleActionType.DOUBLE_BUFFER)
def transpose_direct(progress: Progress) -> NoReturn:
    """
    :param progress:
    :return:
    """
    pattern = progress.op_schedule_info.op_pattern
    next_todo = EmitInsnAction(pattern)
    progress.todo = next_todo


@director_register([ComputePattern.TUPLE_REDUCE, ComputePattern.REDUCE], ScheduleActionType.DOUBLE_BUFFER)
def reduce_direct(progress: Progress) -> NoReturn:
    """
    :param progress:
    :return:
    """
    pattern = progress.op_schedule_info.op_pattern
    if support_ub_transpose_search(progress.op_schedule_info):
        next_todo = UbTransposeAction(pattern)
    else:
        next_todo = EmitInsnAction(pattern)
    progress.todo = next_todo
