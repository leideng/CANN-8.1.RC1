#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
pooling reduce emit insn
"""
from auto_search.solution_space.tensor_cfg import FeatureTensorCfg
from auto_search.bank.cheque_generator import get_emit_insn_cheque
from auto_search.utils.util import DTYPE_BYTE_MAPPING
from auto_search.utils.util import BLOCK_SIZE
from auto_search.utils.util import DTYPE_REPEAT_MAPPING
from auto_search.solution_space.schedule_action.emit_insn.apply_action.rules.comm import \
    get_emit_insn_axis

REDUCE_TRANS = "trans"
STORAGE_BOUND = "storage_bound"
REDUCE_OPT_MODE = "reduce_opt_mode"
WINDOW = "window"


def proc(progress):
    """
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    stage_index = op_schedule_info.stage_index

    if op_schedule_info.proc_flag_dict.get(stage_index, False):
        return True

    stage_type = op_schedule_info.stages_info[stage_index].get('type')
    if {'reduce_rfactor', "reduce"} & set(stage_type):
        _do_emit_insn_for_reduce_window(op_schedule_info, stage_index)

    return True


def _do_emit_insn_for_reduce_window(op_schedule_info, stage_index):
    """
    :param op_schedule_info:
    :param stage_index:
    :return:
    """
    stage_name = op_schedule_info.stage_name
    op_intrin_key_index = op_schedule_info.op_intrin_key_index
    axis_info_list = op_schedule_info.axis_info_list
    intrinsic_func_name = op_intrin_key_index[op_schedule_info.feature_tensor[stage_index][
        FeatureTensorCfg.compute_s]].intrin
    axis_num, emit_insn_axis, emit_insn_axis_obj = get_emit_insn_axis(
        op_schedule_info.stage, stage_index, axis_info_list,
        op_schedule_info.stages_info[stage_index])

    attrs = {WINDOW: True}
    op_schedule_info.stage.emit_insn(emit_insn_axis_obj, intrinsic_func_name, attrs=attrs)
    op_schedule_info.code_lines.append(
        f"sch[{stage_name}].emit_insn({emit_insn_axis}, '{intrinsic_func_name}', {str(attrs)})")

    cheque = get_emit_insn_cheque(stage_index, intrinsic_func_name, (emit_insn_axis, axis_num), extra_info=attrs)
    op_schedule_info.cheque_list.append(cheque)

    op_schedule_info.proc_flag_dict[stage_index] = True
