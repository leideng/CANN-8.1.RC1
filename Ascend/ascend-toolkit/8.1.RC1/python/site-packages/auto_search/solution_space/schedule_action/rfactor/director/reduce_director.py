#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common director
"""
from auto_search.solution_space.action import director_register
from auto_search.solution_space.action import ScheduleActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.schedule_action.split.split_action import SchSplitAction
from auto_search.solution_space.schedule_action.rfactor.rfactor_action import RfactorAction
from auto_search.solution_space.schedule_action.rfactor.rfactor_action import RfactorType
from auto_search.solution_space.schedule_action.reorder.reorder_action \
    import ReorderAction


@director_register([ComputePattern.TUPLE_REDUCE, ComputePattern.REDUCE], ScheduleActionType.RFACTOR)
def direct(progress):
    """
    :param progress:
    :return:
    """
    pattern = progress.op_schedule_info.op_pattern
    reduce_info_for_rfactor = progress.todo.reduce_info_for_rfactor
    if progress.todo.rfactor_type == RfactorType.ATOMIC_RFACTOR:
        do_rfactor_before_split = reduce_info_for_rfactor.is_last_reduce \
                                  and reduce_info_for_rfactor.ub_split_reduce_axis \
                                  and not reduce_info_for_rfactor.ub_split_last_reduce_axis \
                                  and pattern == ComputePattern.REDUCE
        if do_rfactor_before_split:
            # last reduce and ub split reduce axis but not last axis should do rfactor before split
            next_todo = RfactorAction(pattern, reduce_info_for_rfactor,
                                      RfactorType.SPLIT_NLAST_REDUCE_AXIS_RFACTOR_FOR_AROMIC)
        else:
            next_todo = SchSplitAction(pattern, reduce_info_for_rfactor)
    elif progress.todo.rfactor_type == RfactorType.SPLIT_NLAST_REDUCE_AXIS_RFACTOR_FOR_AROMIC:
        next_todo = SchSplitAction(pattern, reduce_info_for_rfactor)
    elif progress.todo.rfactor_type == RfactorType.SPLIT_LAST_REDUCE_AXIS_RFACTOR_FOR_ATOMIC:
        next_todo = ReorderAction(pattern)
    elif progress.todo.rfactor_type == RfactorType.SPLIT_NLAST_REDUCE_AXIS_RFACTOR_FOR_NORMAL:
        next_todo = SchSplitAction(pattern, reduce_info_for_rfactor)
    elif progress.todo.rfactor_type == RfactorType.SPLIT_LAST_REDUCE_AXIS_RFACTOR_FOR_NORMAL:
        next_todo = ReorderAction(pattern)
    progress.todo = next_todo
