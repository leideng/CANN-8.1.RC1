#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
set store predicate for set value node
"""
from auto_search.utils import logger
from auto_search.solution_space.t2c_util import MODE_RUNTIME
from auto_search.solution_space.progress import Progress
from auto_search.bank.cheque_generator import get_set_store_predicate_cheque


def proc(progress: Progress) -> bool:
    """
    :param progress:
    :return:
    """
    code_lines = []
    op_schedule_info = progress.op_schedule_info

    # do set_store_predicate
    for stage_ind, stage_ in enumerate(op_schedule_info.schedule_obj.stages):
        stage_name = op_schedule_info.stages_info[stage_ind]['name']
        if stage_.op.tag == 'set_value' and stage_.scope == 'local.UB':
            code_line = 'sch[%s].set_store_predicate(sch[%s].op.body[0].condition)' % (
                            stage_name, stage_name)
            code_lines.append(code_line)
            if op_schedule_info.mode == MODE_RUNTIME:
                stage_.set_store_predicate(stage_.op.body[0].condition)

            cheque = get_set_store_predicate_cheque(stage_ind)
            op_schedule_info.cheque_list.append(cheque)

    op_schedule_info.code_lines.extend(code_lines)
    logger.debug('code_lines: %s' % ("\n".join(op_schedule_info.code_lines)))

    return True
