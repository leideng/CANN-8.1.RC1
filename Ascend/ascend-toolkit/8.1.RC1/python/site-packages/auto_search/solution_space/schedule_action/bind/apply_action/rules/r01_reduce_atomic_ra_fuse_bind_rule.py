#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
reduce atomic bind rule
"""
from tbe import tvm

from auto_search.solution_space.tensor_cfg import AxisInfo
from auto_search.utils import logger
from auto_search.solution_space.t2c_util import MODE_RUNTIME
from auto_search.solution_space.progress import Progress
from auto_search.bank.cheque_generator import get_bind_cheque
from auto_search.bank.cheque_generator import get_fuse_cheque


def proc(progress: Progress) -> bool:
    """
    reduce atomic bind core
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    if not op_schedule_info.is_atomic:
        return True

    if not op_schedule_info.enable_atomic_ra_bind:
        return True

    # only one stage bind core
    bind_stage, bind_stage_index = op_schedule_info.bind_stages[0]

    # if current stage has been proc, skip
    if op_schedule_info.proc_flag_dict.get(bind_stage_index, False):
        return True

    bind_stage_name = op_schedule_info.stages_info[bind_stage_index]['name']
    logger.debug("bind_stage: %s, bind_stage_index: %s, bind_stage_name: %s",
                 bind_stage, bind_stage_index, bind_stage_name)

    # fuse
    fuse_axis_name = '%s_axis_fused_o' % bind_stage_name
    fused_axes_obj_list = []
    fused_axes_name = []
    index_list = []
    fuse_len = 1
    block_split_outer_name = op_schedule_info.atomic_block_split_info.outer_axis_name
    axis_info_list = op_schedule_info.axis_info_list[bind_stage_index]
    for axis_index, axis in enumerate(axis_info_list):
        fused_axes_obj_list.append(axis.body)
        fused_axes_name.append(axis.name)
        index_list.append(axis_index)
        fuse_len *= axis.len
        if axis.name == block_split_outer_name:
            break

    code_line = f"{fuse_axis_name} = sch[{bind_stage_name}].fuse({', '.join(fused_axes_name)})"
    op_schedule_info.code_lines.append(code_line)
    fused_axis_obj = None
    if op_schedule_info.mode == MODE_RUNTIME:
        fused_axis_obj = bind_stage.fuse(*fused_axes_obj_list)

    # axis_info_list update
    del axis_info_list[index_list[0]: index_list[-1] + 1]
    axis_info_list.insert(index_list[0],
                          AxisInfo(fuse_axis_name, fuse_len,
                                   'fused_axis', index_list[0], 'o', fused_axis_obj))
    op_schedule_info.axis_info_list[bind_stage_index] = axis_info_list

    fuse_cheque = get_fuse_cheque(bind_stage_index, index_list)
    op_schedule_info.cheque_list.append(fuse_cheque)

    op_schedule_info.code_lines.append("block = tvm.thread_axis('blockIdx.x')")
    op_schedule_info.code_lines.append(
        "sch[%s].bind(%s, block)" %
        (bind_stage_name, fuse_axis_name))

    op_schedule_info.proc_flag_dict[bind_stage_index] = True

    if op_schedule_info.mode == MODE_RUNTIME:
        block = tvm.thread_axis('blockIdx.x')
        bind_stage.bind(fused_axis_obj, block)

    cheque = get_bind_cheque(bind_stage_index)
    op_schedule_info.cheque_list.append(cheque)

    return True
