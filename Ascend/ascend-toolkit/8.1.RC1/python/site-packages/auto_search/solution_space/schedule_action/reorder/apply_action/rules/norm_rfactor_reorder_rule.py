#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
auto search
"""
from auto_search.utils import logger
from auto_search.solution_space import t2c_util
from auto_search.solution_space.progress import Progress


def set_normal_axis_of_reduce_stage(op_schedule_info):
    """

    :param op_schedule_info:
    :return:
    """
    for stage_index, stage_axis_list in enumerate(op_schedule_info.axis_info_list):
        if stage_axis_list is None:
            continue
        insert_pos = 0
        for axis_info in stage_axis_list:
            axes = op_schedule_info.leveled_axis_for_reorder[stage_index]

            axis_info_list = axes[t2c_util.AXIS_LEVEL_OO_INDEX] + \
                             axes[t2c_util.AXIS_LEVEL_O_INDEX] + \
                             axes[t2c_util.AXIS_LEVEL_I_II_NORMAL_INDEX]
            if axis_info in axis_info_list:
                continue
            op_schedule_info.leveled_axis_for_reorder[stage_index][
                t2c_util.AXIS_LEVEL_I_II_NORMAL_INDEX].insert(
                    insert_pos, axis_info)
            insert_pos += 1

    logger.debug('leveled_axis_for_reorder: %s.',
                 op_schedule_info.leveled_axis_for_reorder)


def proc(progress: Progress):
    """
    reduce_rfactor reorder the reduce axis
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info

    set_normal_axis_of_reduce_stage(op_schedule_info)

    leveled_axis_list = op_schedule_info.leveled_axis_for_reorder
    for idx, leveled_axis in enumerate(leveled_axis_list):
        stage_info = op_schedule_info.stages_info[idx]
        if 'reduce_rfactor' not in stage_info.get('type', []):
            continue

        normal_axis_info = []
        reduce_axis_info = []

        for each_axis in leveled_axis[t2c_util.AXIS_LEVEL_I_II_NORMAL_INDEX]:
            if 'reduce_axis' not in each_axis.name:
                normal_axis_info.append(each_axis)
            else:
                reduce_axis_info.append(each_axis)

        leveled_axis_list[idx][t2c_util.AXIS_LEVEL_I_II_NORMAL_INDEX] = reduce_axis_info + normal_axis_info
