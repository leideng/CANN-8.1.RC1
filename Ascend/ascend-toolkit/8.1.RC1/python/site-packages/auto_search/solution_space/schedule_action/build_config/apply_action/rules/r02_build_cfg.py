#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
build config
"""
from tbe.common.platform import ASCEND_910B
from tbe.common.platform.platform_info import get_soc_spec
from auto_search.bank.cheque_generator import get_build_cfg_cheque
from auto_search.solution_space.progress import Progress

DEFAULT_BUILD_CFG_ASCEND910B = {
    "enable_loop_partition": True,
    "enable_precise_sync_in_emit_insn": False,
    "out_of_bound_sync_check": False
}


def proc(progress: Progress) -> bool:
    """
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    version = get_soc_spec("SHORT_SOC_VERSION")
    if version not in [ASCEND_910B]:
        return True

    for attr_tag, value in DEFAULT_BUILD_CFG_ASCEND910B.items():
        # gen cheque
        cheque = get_build_cfg_cheque(attr_tag, value)
        op_schedule_info.cheque_list.append(cheque)

    # gen code lines for build_config
    op_schedule_info.code_lines.append('')
    build_cfg_code = '''
    # build config
    dynamic_build_config["enable_loop_partition"] = {enable_loop_partition}
    dynamic_build_config["enable_precise_sync_in_emit_insn"] = {enable_precise_sync_in_emit_insn}
    dynamic_build_config["out_of_bound_sync_check"] = {out_of_bound_sync_check}
    '''
    code_str = build_cfg_code.format(
        enable_loop_partition=DEFAULT_BUILD_CFG_ASCEND910B.get("enable_loop_partition"),
        enable_precise_sync_in_emit_insn=DEFAULT_BUILD_CFG_ASCEND910B.get("enable_precise_sync_in_emit_insn"),
        out_of_bound_sync_check=DEFAULT_BUILD_CFG_ASCEND910B.get("out_of_bound_sync_check"))
    op_schedule_info.code_lines.append(code_str)

    return True
