#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
inline rule
"""
from auto_search.solution_space.progress import Progress
from tbe.common.platform.platform_info import get_soc_spec


def proc(progress: Progress, stage_index: int) -> bool:
    """
    last broadcast inline braodcast tensor
    :param progress:
    :param stage_index:
    :return:
    """
    version = get_soc_spec("SHORT_SOC_VERSION")
    if version not in ['Ascend910B']:
        return False
    op_schedule_info = progress.op_schedule_info
    stage = op_schedule_info.schedule_obj.stages[stage_index]
    at_stage = op_schedule_info.at_dict.get(stage_index)
    if at_stage is not None:
        split_axis = op_schedule_info.stages_info[at_stage].get('choose_axis')
        if split_axis is None:
            return False
    else:
        return False

    #  the last axis is broadcast and is not the split_axis
    if stage.op.tag in ['unified_broadcast'] and '.local.' in stage.op.name:
        input_shape = stage.op.input_tensors[0].shape
        output_shape = stage.op.output(0).shape
        if int(input_shape[-1]) != int(output_shape[-1]) and split_axis != len(input_shape) - 1:
            return True

    return False
