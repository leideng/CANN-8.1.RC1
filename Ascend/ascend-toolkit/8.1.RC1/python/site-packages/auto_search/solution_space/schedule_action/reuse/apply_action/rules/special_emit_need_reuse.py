#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
reused_by rule
"""
from typing import Dict
from typing import NoReturn


from auto_search.solution_space.t2c_util import MODE_RUNTIME
from auto_search.bank.cheque_generator import get_reuseby_cheque
from auto_search.solution_space.progress import Progress


def _get_reused_tensor_map(progress: Progress, special_cast_map: Dict) -> NoReturn:
    """
    get_reused_tensor_map
    :param progress:
    :param special_cast_map:
    :return:
    """
    ternary_reuse_map = {
        "elewise_binary_scalar_axpy": 1,
        "elewise_multiple_mla": 2,
        "elewise_multiple_madd": 1,
        "elewise_multiple_maddrelu": 1,
    }

    def _get_dsl_insn(stage_info):
        tag = stage_info.get('tag', '')
        if tag.find("|") != -1:
            temp_insn = tag.split("|")[0]
        else:
            temp_insn = tag
        return temp_insn

    for stage_index, stage_info in enumerate(progress.op_schedule_info.stages_info):
        insn = _get_dsl_insn(stage_info)
        if insn not in ternary_reuse_map or 'CacheWrite' not in stage_info.get("type", ""):
            continue

        reuse_index = ternary_reuse_map.get(insn, 1)
        fanin_stage_indices = progress.op_schedule_info.real_fanin_dict[
            stage_index]

        reuse_src_index = fanin_stage_indices[reuse_index]

        dst_stage_index = stage_index
        special_cast_map[reuse_src_index] = dst_stage_index


def proc(progress: Progress) -> bool:
    """
    special cast do reused_by
    :param progress:
    :return:
    """
    op_schedule_info = progress.op_schedule_info
    sch = op_schedule_info.schedule_obj
    stages = list(sch.stages)
    special_cast_with_ori_tensor_map = {}
    _get_reused_tensor_map(progress, special_cast_with_ori_tensor_map)

    for reuse_src_index, dst_stage_index in special_cast_with_ori_tensor_map.items():
        reuse_src_name = op_schedule_info.stages_info[reuse_src_index]["name"]
        reuse_dst_name = op_schedule_info.stages_info[dst_stage_index]["name"]
        if op_schedule_info.mode == MODE_RUNTIME:
            stages[reuse_src_index].reused_by(stages[dst_stage_index].origin_op.output(0))
            stages[dst_stage_index].reused_by(reuse_data=True)

        op_schedule_info.code_lines.append("sch[%s].reused_by(%s)" %
                                           (reuse_src_name, reuse_dst_name))
        op_schedule_info.code_lines.append("sch[%s].reused_by(reuse_data=True)" %
                                           reuse_dst_name)

        # gen cheque
        cheque = get_reuseby_cheque(reuse_src_index, dst_stage_index=dst_stage_index)
        op_schedule_info.cheque_list.append(cheque)
        cheque = get_reuseby_cheque(reuse_src_index, reuse_data=True)
        op_schedule_info.cheque_list.append(cheque)

    return True
