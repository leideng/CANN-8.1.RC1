#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common apply action
"""
from auto_search.utils import logger
from auto_search.solution_space.tensor_cfg import AXIS_CNT
from auto_search.solution_space.tensor_cfg import ActionTensorCfg
from auto_search.solution_space.action import apply_action_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern


@apply_action_register([ComputePattern.ELEMENTWISE, ComputePattern.BROADCAST, ComputePattern.POOLING,
                        ComputePattern.REDUCE, ComputePattern.NORM, ComputePattern.TRANSPOSE,
                        ComputePattern.TUPLE_REDUCE],
                       SearchActionType.SPLIT)
def apply(next_progress, action_value):
    """
    :param next_progress:
    :param action_value:
    :return:
    """
    stage_index = next_progress.todo.stage_index
    start_factor_index = ActionTensorCfg.split_factor_s + next_progress.todo.cache_layer * AXIS_CNT
    factor_index = start_factor_index + next_progress.todo.axis_index
    sub_action_index = next_progress.todo.sub_action_index
    factor_delta = pow(AXIS_CNT, sub_action_index) * action_value
    next_progress.action_tensor[stage_index][factor_index] += factor_delta
    logger.debug("factor: %s", next_progress.action_tensor[stage_index][factor_index])
