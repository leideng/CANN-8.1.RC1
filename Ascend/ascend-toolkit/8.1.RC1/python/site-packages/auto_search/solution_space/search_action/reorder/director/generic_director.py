#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common director
"""
import copy

from auto_search.solution_space.action import director_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.schedule_action.cache_write.cache_write_action import CacheWriteAction


@director_register([ComputePattern.TRANSPOSE], SearchActionType.REORDER)
def direct(progress):
    """
    reorder action direct
    :param progress:
    :return:
    """
    # reorder search not finish, continue
    pattern = progress.op_schedule_info.op_pattern
    if progress.todo.sub_action_index > 0:
        next_todo = copy.deepcopy(progress.todo)
        next_todo.action_value = None
        next_todo.sub_action_index -= 1
        progress.todo = next_todo
    else:
        stage_index = progress.todo.stage_index
        next_action = CacheWriteAction(pattern, stage_index)
        progress.todo = next_action
