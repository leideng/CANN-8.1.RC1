#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from numpy import ndarray

from auto_search.utils import logger
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.features import SEARCH_N
from auto_search.solution_space.progress import Progress


@mask_rule_register([ComputePattern.NORM], SearchActionType.CHOOSE_AXIS)
def proc(progress: Progress, action_mask: ndarray):
    """
    :param progress:
    :param action_mask:
    :return:
    """
    stage_index = progress.todo.stage_index
    if stage_index not in progress.op_schedule_info.reduce_axis_dict:
        return action_mask

    stage_ordered_axes_obj = progress.op_schedule_info.stages_info[stage_index].get('stage_ordered_axes_obj')
    reduce_axis = stage_ordered_axes_obj.get_reduce_axes()

    for idx in range(SEARCH_N):
        if idx not in reduce_axis:
            action_mask[idx] = 0

    if sum(action_mask) == 0:
        action_mask[reduce_axis[0]] = 1

    logger.debug("norm choose_axis:%s", action_mask)
    return action_mask
