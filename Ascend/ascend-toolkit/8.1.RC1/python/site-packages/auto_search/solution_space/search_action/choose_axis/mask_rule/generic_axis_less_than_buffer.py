#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""
from numpy import ndarray

from auto_search.solution_space.features import SEARCH_N
from auto_search.solution_space.features import UB_BUFFER_SIZE
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.progress import Progress


@mask_rule_register([ComputePattern.BROADCAST, ComputePattern.ELEMENTWISE, ComputePattern.NORM],
                    SearchActionType.CHOOSE_AXIS)
def mask(progress: Progress, action_mask: ndarray):
    """
    :param progress:
    :param action_mask:
    :return:
    """
    nonzero_axes = progress.get_nonzero_axes(progress.todo.stage_index)
    total_size = 1

    for idx in range(SEARCH_N - 1, -1, -1):

        if idx >= len(nonzero_axes):
            action_mask[idx] = 0
            continue

        if nonzero_axes[idx] == 1:
            action_mask[idx] = 0

        if total_size > UB_BUFFER_SIZE:
            action_mask[idx] = 0
        total_size *= nonzero_axes[idx]

    if sum(action_mask) == 0:
        action_mask[0] = 1

    return action_mask
