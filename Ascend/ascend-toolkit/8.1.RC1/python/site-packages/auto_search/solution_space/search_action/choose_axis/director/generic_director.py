#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
common director
"""
from auto_search.solution_space.action import director_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.search_action.split.split_action import SplitAction
from auto_search.solution_space.comm import get_split_sub_tree_depth
from auto_search.solution_space.progress import Progress
from auto_search.solution_space.tensor_cfg import AXIS_CNT


@director_register([ComputePattern.BROADCAST, ComputePattern.ELEMENTWISE, ComputePattern.REDUCE, ComputePattern.NORM,
                    ComputePattern.POOLING, ComputePattern.TRANSPOSE, ComputePattern.TUPLE_REDUCE],
                   SearchActionType.CHOOSE_AXIS)
def direct(progress: Progress):
    """
    choose axis, then split
    :param progress:
    :return:
    """
    pattern = progress.op_schedule_info.op_pattern
    chosen_axis = progress.todo.action_value
    stage_index = progress.todo.stage_index
    nonzero_axes = progress.get_nonzero_axes(stage_index)
    chosen_axis_len = nonzero_axes[chosen_axis]
    sub_tree_depth = get_split_sub_tree_depth(chosen_axis_len)
    progress.todo = SplitAction(pattern, stage_index, sub_tree_depth - 1, chosen_axis)


@director_register([ComputePattern.POOLING], SearchActionType.CHOOSE_AXIS)
def direct_for_pooling(progress: Progress):
    """
    pooling choose axis
    :param progress:
    :return:
    """
    pattern = progress.op_schedule_info.op_pattern
    chosen_axis = progress.todo.action_value
    stage_index = progress.todo.stage_index
    if stage_index not in progress.op_schedule_info.reduce_axis_dict:
        nonzero_axes = progress.get_nonzero_axes(stage_index)
        chosen_axis_len = nonzero_axes[chosen_axis]
    else:
        chosen_axis_len = progress.op_schedule_info.feature_tensor[stage_index][AXIS_CNT + chosen_axis]
    sub_tree_depth = get_split_sub_tree_depth(chosen_axis_len)
    progress.todo = SplitAction(pattern, stage_index, sub_tree_depth - 1, chosen_axis)
