#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
mask rule
"""
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern


@mask_rule_register([ComputePattern.NORM], SearchActionType.CHOOSE_CACHE_CLONE)
def mask(progress, action_mask):
    """
    # if input num greater then 5, do not choose cache clone
    :param progress:
    :param action_mask:
    :return:
    """
    stage_index = progress.todo.stage_index
    progress.op_schedule_info.update_dependency_dict()
    all_fanin = progress.op_schedule_info.all_fanin_dict[stage_index]
    real_fanin = progress.op_schedule_info.real_fanin_dict[stage_index]

    for in_stage in real_fanin:
        if 'workspace' in progress.op_schedule_info.stages_info[in_stage].get('type', []):
            for x in progress.op_schedule_info.all_fanin_dict[in_stage]:
                all_fanin.remove(x)
    # if input num greater then 5, do not choose cache clone
    if len(all_fanin) > 5:
        action_mask[1] = 0

    for in_stage_idx in all_fanin:
        stage_info = progress.op_schedule_info.stages_info[in_stage_idx]
        if 'reduce' in stage_info['tag']:
            action_mask[1] = 0

    return action_mask
