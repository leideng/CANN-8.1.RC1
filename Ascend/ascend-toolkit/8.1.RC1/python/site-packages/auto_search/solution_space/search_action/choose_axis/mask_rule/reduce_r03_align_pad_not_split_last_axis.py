#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
mask rule
"""
from auto_search.utils import logger
from auto_search.solution_space.features import SEARCH_N
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern


@mask_rule_register([ComputePattern.TUPLE_REDUCE, ComputePattern.REDUCE], SearchActionType.CHOOSE_AXIS)
def mask(progress, action_mask):
    """
    if align_pad is open, not split last axis:
    1. ar reduce can not split r
    2. a0ra1 res and reduce can not split a1
    :param progress:
    :param action_mask:
    :return:
    """
    if not progress.op_schedule_info.is_align_pad or progress.op_schedule_info.is_atomic:
        return
    stage_index = progress.todo.stage_index

    reduce_compute_graph = progress.op_schedule_info.compute_graph_info
    # ar scene
    if reduce_compute_graph.is_last_reduce:
        if stage_index == len(progress.op_schedule_info.schedule_obj.stages) - 1:
            return
        for idx in range(SEARCH_N - 1, -1, -1):
            if idx == len(reduce_compute_graph.shape_before_reduce) - 1:
                action_mask[idx] = 0
        return
    # a0ra1
    # res stage
    if stage_index == len(progress.op_schedule_info.schedule_obj.stages) - 1:
        for idx in range(SEARCH_N - 1, -1, -1):
            if idx == len(reduce_compute_graph.shape_after_reduce) - 1:
                action_mask[idx] = 0
        return
    # reduce stage
    for idx in range(SEARCH_N - 1, -1, -1):
        if idx == len(reduce_compute_graph.shape_after_reduce) - 1:
            action_mask[idx] = 0

    logger.debug("reduce_r03_align_pad_not_split_last_axis, action_mask:%s", action_mask)
