#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2019-2020. All rights reserved.

rl schedule search, tss
"""

from math import factorial
from numpy import ndarray

from auto_search.utils import logger
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.features import SEARCH_N
from auto_search.solution_space.progress import Progress
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType


@mask_rule_register([ComputePattern.TRANSPOSE], SearchActionType.REORDER)
def mask(progress: Progress, action_mask: ndarray):
    """
    search reorder mask
    :param progress: Progress
    :param action_mask: action mask
    :return: action mask
    """
    stage_index = progress.todo.stage_index
    stage_info = progress.op_schedule_info.stages_info[stage_index]

    nonzero_axes = progress.get_nonzero_axes(0)
    # get max reorder_num
    max_reorder_num = factorial(len(nonzero_axes))

    # get reorder_num
    reorder_num = stage_info.get('transpose_reorder_num', 0)

    # mask over max_reorder_num
    for i in range(SEARCH_N):
        next_reorder_num = reorder_num + pow(
            SEARCH_N, progress.todo.sub_action_index) * i
        if next_reorder_num >= max_reorder_num:
            action_mask[i] = 0

    if sum(action_mask) == 0:
        action_mask[0] = 1

    logger.debug("transpose_r01_reorder_num_range action_mask:%s", action_mask)
