#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.

auto search
"""
from numpy import ndarray

from auto_search.utils import logger
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern
from auto_search.solution_space.features import SEARCH_N
from auto_search.solution_space.progress import Progress


@mask_rule_register([ComputePattern.POOLING], SearchActionType.CHOOSE_AXIS)
def proc(progress: Progress, action_mask: ndarray):
    """
    :param progress:
    :param action_mask:
    :return:
    """
    stage_index = progress.todo.stage_index
    stage = progress.op_schedule_info.schedule_obj.stages[stage_index]
    if stage_index not in progress.op_schedule_info.reduce_axis_dict:
        for idx in range(SEARCH_N):
            if idx >= len(stage.op.axis):
                action_mask[idx] = 0
        return action_mask

    for idx in range(SEARCH_N):
        if idx >= len(stage.op.reduce_axis):
            action_mask[idx] = 0

    logger.debug("pooling choose_axis:%s", action_mask)
    return action_mask
