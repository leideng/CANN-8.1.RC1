#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# Copyright (c) Huawei Technologies Co., Ltd. 2022-2022. All rights reserved.
"""
mask rule
"""
from auto_search.utils import logger
from auto_search.solution_space.action import mask_rule_register
from auto_search.solution_space.action import SearchActionType
from auto_search.compute_analysis import ComputePattern


@mask_rule_register([ComputePattern.REDUCE, ComputePattern.NORM, ComputePattern.POOLING,
                     ComputePattern.TUPLE_REDUCE], SearchActionType.AT_STAGE)
def mask(progress, action_mask):
    """
    :param progress:
    :param action_mask:
    :return:
    """
    stage_index = progress.todo.stage_index
    consumer_id = progress.todo.consumer_id

    at_info = progress.op_schedule_info.stages_info[stage_index]['at_info']
    consumer = at_info.consumers[consumer_id]
    at_stage_num = len(consumer.at_candidates)
    for i in range(at_stage_num, len(action_mask)):
        action_mask[i] = 0

    if sum(action_mask) == 0:
        logger.warn('No need to mask, because no available at target.')

    return action_mask
