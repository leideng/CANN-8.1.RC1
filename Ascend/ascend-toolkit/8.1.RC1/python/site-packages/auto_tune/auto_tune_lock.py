#!/usr/bin/env python
# -*- coding:utf-8 -*-
"""
Copyright (C) 2019. Huawei Technologies Co., Ltd. All rights reserved.

Define the Lock class
"""
import os
import fcntl
from auto_tune.auto_tune_log import LOG_INSTANCE
from auto_tune.util_atc import create_dir
from auto_tune.util_atc import FILE_FLAG
from auto_tune.util_atc import FILE_MODE_640


def write_to_file(file_path: str, content: str = "") -> bool:
    """

    :param file_path:
    :param content:
    :return:
    """
    dir_name = os.path.dirname(file_path)
    ret = create_dir(dir_name)
    if not ret:
        LOG_INSTANCE.error('create dir: {} failed!'.format(dir_name))
        return False

    with os.fdopen(os.open(file_path, FILE_FLAG, FILE_MODE_640), 'w') as file_handler:
        file_handler.write(content)

    return True


class LocalLock:
    """
    LocalLock
    """
    def __init__(self, lock_file: str) -> None:
        if not os.path.exists(lock_file):
            LOG_INSTANCE.debug("Lock_file: {} doesn't exist.".format(lock_file))
            write_to_file(lock_file)
        self.lock_fd = os.open(lock_file, FILE_FLAG)

    def lock(self) -> None:
        """
        lock
        """
        fcntl.flock(self.lock_fd, fcntl.LOCK_EX)

    def unlock(self) -> None:
        """
        unlock
        """
        os.close(self.lock_fd)
