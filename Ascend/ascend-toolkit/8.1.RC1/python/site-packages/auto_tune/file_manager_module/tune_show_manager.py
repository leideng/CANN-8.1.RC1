#!/usr/bin/env python
# -*- coding:utf-8 -*-
"""
Copyright (C) 2022. Huawei Technologies Co., Ltd. All rights reserved.

Define tune show interfaces.
"""
import os
import fcntl

from auto_tune.util_atc import FILE_FLAG
from auto_tune.util_atc import FILE_MODE_640
from auto_tune.util_atc import create_dir
from auto_tune.util_atc import create_file
from auto_tune.util_atc import remove_file
from auto_tune.auto_tune_lock import LocalLock
from auto_tune.common_module.common_util import TuneOpParam


def create_tune_show(input_args: dict, tune_op_params: TuneOpParam) -> str:
    """
    create tune show dir and flag file
    """
    cur_path = os.path.realpath(os.getcwd())
    file_dir = os.path.join(cur_path, "tune_show_%s" % tune_op_params.time_stamp)
    create_tune_show_dir(cur_path, file_dir)
    op_tune_flag = os.path.join(file_dir, "{}.flag".format(input_args.get("shape_args").get("kernel_name")))
    write_flag_file(op_tune_flag, input_args)
    return op_tune_flag


def create_tune_show_dir(cur_path: str, file_dir: str) -> None:
    """
    create tune_show_dir
    """
    file_lock_path = os.path.join(cur_path, "file.lock")
    in_use_flag = os.path.join(file_dir, "GA_in_use.flag")
    with os.fdopen(os.open(file_lock_path, FILE_FLAG, FILE_MODE_640), 'w') as file_lock:
        fcntl.flock(file_lock.fileno(), fcntl.LOCK_EX)
        create_dir(file_dir)
        create_file(in_use_flag)
        fcntl.flock(file_lock.fileno(), fcntl.LOCK_UN)
    remove_file(file_lock_path)


def write_flag_file(op_tune_flag: str, input_args: dict) -> None:
    """
    create op_flag file and write ori_op_name in file
    """
    local_lock = LocalLock(op_tune_flag)
    local_lock.lock()
    with os.fdopen(os.open(op_tune_flag, FILE_FLAG, FILE_MODE_640), 'w') as flag_file:
        flag_file.write(input_args.get("topi_args").get('ori_op_name'))
    local_lock.unlock()
