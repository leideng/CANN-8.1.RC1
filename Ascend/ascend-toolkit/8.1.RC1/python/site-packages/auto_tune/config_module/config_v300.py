#!/usr/bin/env python
# -*- coding:utf-8 -*-
"""
Copyright (C) 2022. Huawei Technologies Co., Ltd. All rights reserved.

Define the v300 config
"""
from auto_tune.common_module.common_util import MAX_UINT32
from auto_tune.common_module.common_util import MAX_UINT16
from auto_tune.common_module.common_util import MKN
from auto_tune.common_module.common_util import CA0


# tiling output parameter type
TILING_STRUCTURE_TYPE_V300 = 1
HALF_INDEX_V300 = 32
CONFIG_KEYS_V300 = [
    "batch_dim", "group_dim", "d_dim",
    "m_dim", "AL1_pbuffer",
    "AL1_shape_0", "AL1_shape_1", "AL1_shape_2", "AL1_shape_3", "AL1_shape_4",
    "n_dim", "BL1_pbuffer", "BL1_shape_0", "BL1_shape_1", "BL1_shape_2", "BL1_shape_3", "BL1_shape_4",
    "multi_n_L1_sparse_index",
    "INPUT_L1_FB_pbuffer", "INPUT_L1_FB_param", "INPUT_L1_BT_pbuffer", "INPUT_L1_BT_param",
    "INPUT_L1_eltwise_pbuffer", "INPUT_L1_eltwise_param",
    "AL0_pbuffer", "ma", "ka", "batcha", "groupa", "da",
    "BL0_pbuffer", "kb", "nb", "batchb", "groupb", "db",
    "CL0_pbuffer", "mc", "nc", "batchc", "groupc", "dc",
    "AUB_pbuffer", "AUB_shape_0", "AUB_shape_1", "AUB_shape_2", "AUB_shape_3", "AUB_channel_wise_flag",
    "BUB_pbuffer", "BUB_shape_0", "BUB_shape_1", "BUB_shape_2", "BUB_shape_3", "BUB_channel_wise_flag",
    "L0C_OUTPUT_pbuffer", "UBG_pbuffer", "nc_factor", "mc_factor",
    "batch_L0C_OUTPUT", "group_L0C_OUTPUT", "vector_block_num", "CUB_channel_wise_flag",
    "control_reorder_flag",
    "special_optimize_flag"
]
TILING_SPACE_NONE_0_REPLACE_V300 = ["AUB_shape_0", "BUB_shape_0", "AL1_shape_0", "BL1_shape_0"]
FULL_LOAD_PAIRS_V300 = {
    "AUB_shape_0": MAX_UINT32, "AL1_shape_0": MAX_UINT32, "BL1_shape_0": MAX_UINT32, "kb": MAX_UINT16
}
SPLIT_MAP_V300 = {0: None, 1: "slice", 2: "all"}
BOOL_KEYS_V300 = ["CUB_channel_wise_flag"]
NONE_KEYS_V300 = ["AUB_channel_wise_flag", "BUB_channel_wise_flag"]
CROSS_POINTS_V300 = [
    "m_dim", "n_dim", "INPUT_L1_FB_pbuffer", "INPUT_L1_eltwise_pbuffer", "AL0_pbuffer",
    "BL0_pbuffer", "CL0_pbuffer", "AUB_pbuffer", "BUB_pbuffer", "L0C_OUTPUT_pbuffer",
    "control_reorder_flag", "special_optimize_flag"
]
# mutable point is selected by same probility,  but some locations are not involved in mutation
UNMUTABLE_POINTS_KEYS_V300 = ["UBG_pbuffer"]
TILING_DICT_STRUCTURE_V300 = {
    "AUB_shape": ["AUB_shape_0", "AUB_shape_1", "AUB_shape_2", "AUB_shape_3"],
    "BUB_shape": ["BUB_shape_0", "BUB_shape_1", "BUB_shape_2", "BUB_shape_3"],
    "AL1_shape": ["AL1_shape_0", "AL1_shape_1", "AL1_shape_2", "AL1_shape_3", "AL1_shape_4"],
    "BL1_shape": ["BL1_shape_0", "BL1_shape_1", "BL1_shape_2", "BL1_shape_3", "BL1_shape_4"],
    "AL0_matrix": ["ma", "ka", MKN, CA0, "batcha", "groupa", "da"],
    "BL0_matrix": ["kb", "nb", MKN, CA0, "batchb", "groupb", "db"],
    "CL0_matrix": ["nc", "mc", MKN, MKN, "batchc", "groupc", "dc"],
    "block_dim": ["batch_dim", "n_dim", "m_dim", "group_dim", "d_dim"],
    "control_reorder_flag": "control_reorder_flag",
    "special_optimize_flag": "special_optimize_flag",
    "UB_channel_wise_input": ["AUB_channel_wise_flag", "BUB_channel_wise_flag", "CUB_channel_wise_flag"],
    "manual_pingpong_buffer": {
        "AUB_pbuffer": "AUB_pbuffer",
        "BUB_pbuffer": "BUB_pbuffer",
        "AL1_pbuffer": "AL1_pbuffer",
        "BL1_pbuffer": "BL1_pbuffer",
        "AL0_pbuffer": "AL0_pbuffer",
        "BL0_pbuffer": "BL0_pbuffer",
        "CL0_pbuffer": "CL0_pbuffer",
        "L0C_OUTPUT_pbuffer": "L0C_OUTPUT_pbuffer",
        "UBG_pbuffer": "UBG_pbuffer",
        "INPUT_L1_FB_pbuffer": "INPUT_L1_FB_pbuffer",
        "INPUT_L1_eltwise_pbuffer": "INPUT_L1_eltwise_pbuffer",
        "INPUT_L1_BT_pbuffer": "INPUT_L1_BT_pbuffer"
    },
    "INPUT_L1_BT_param": "INPUT_L1_BT_param",
    "INPUT_L1_FB_param": "INPUT_L1_FB_param",
    "INPUT_L1_eltwise_param": "INPUT_L1_eltwise_param",
    "L0C_OUTPUT_matrix": [
        "nc_factor", "mc_factor", MKN, MKN,
        "batch_L0C_OUTPUT", "group_L0C_OUTPUT"
    ],
    "vector_block_num": "vector_block_num"
}

# TILING_STRUCTURE CONFIG
TILING_STRUCTURE_V300 = {
    "tiling_structure_type": TILING_STRUCTURE_TYPE_V300,
    "config_keys": CONFIG_KEYS_V300,
    "full_load_pairs": FULL_LOAD_PAIRS_V300,
    "bool_keys": BOOL_KEYS_V300,
    "none_keys": NONE_KEYS_V300,
    "cross_point_keys": CROSS_POINTS_V300,
    "none_0_replace": TILING_SPACE_NONE_0_REPLACE_V300,
    "unmutable_point_keys": UNMUTABLE_POINTS_KEYS_V300,
    "tiling_dict_structure": TILING_DICT_STRUCTURE_V300,
    "half_index": HALF_INDEX_V300
}

# white list with op type surpport V300
OP_SURPPORT_V300 = [
    "conv2d", "conv2d_backprop_input", "conv2d_backprop_filter", "matmul", "convolution_3d", "conv3d_backprop_input",
    "conv3d_backprop_filter"
]
