#!/usr/bin/env python
# -*- coding:utf-8 -*-
"""
Copyright (C) 2019. Huawei Technologies Co., Ltd. All rights reserved.
FILE:     tik_buffervar.py
DESC:     tik buffervar
CREATED:  2019-12-06 12:32:13
MODIFIED: 2020-12-7 19:17:00
"""
from tbe.tvm import DataType
from tbe.tvm import convert
from tbe.tvm.tir import Ramp
from tbe.tvm.tir import Store
from tbe.tvm.tir import Cast
from tbe.tvm.tir.ir_builder import BufferVar
from tbe.tik.tik_lib.tik_check_util import TikCheckUtil


class TikBufferVar(BufferVar):
    """
    Buffer variable with content type, makes load store easily.
    Do not create it directly, create use IRBuilder.
    """
    def __setitem__(self, index, value):
        value = convert(value)
        value = self.match_context_type(value)
        stmt_node = self.get_stmt_node(value, index)
        self._builder.source_info.set_node_span(stmt_node)
        self._builder.emit(stmt_node)

    def match_context_type(self, value):
        """
        match context type
        :param value: value
        :return: value in content type
        """
        if value.dtype != self._content_type:
            value = Cast(self._content_type, value)
        return value

    def get_stmt_node(self, value, index):
        """
        get stmt node
        :param value: value
        :param index: index
        :return:
        """
        tvm_type = DataType(self._content_type)
        if tvm_type.lanes > 1:
            index = Ramp(index * tvm_type.lanes, 1, tvm_type.lanes)

        stmt_node = Store(self._buffer_var, value, index)
        return stmt_node
