#!/usr/bin/env python
# -*- coding:utf-8 -*-
"""
Copyright (C) 2021. Huawei Technologies Co., Ltd. All rights reserved.
FILE:     tik_dup_ops_api_.py
DESC:     duplicate vector instructions for tik 1.5
CREATED:  2021-06-24 18:53:42
MODIFIED: 2021-06-24 19:17:00
"""

from collections import namedtuple
from tbe import tvm
from tbe.tik.tik_lib.tik_h_vec_api.common_params_check_ import check_duplicate_params
from tbe.tik.tik_lib.tik_h_vec_api.common_util_ import set_tik_version_1_5
from tbe.tik.tik_lib.tik_source_info import source_info_decorator
from tbe.tik.tik_lib.tik_expr import Expr
from tbe.tik.tik_lib.tik_h_vec_api.tik_h_vec_api_base_ import TikHVecApiBase
from tbe.tik.debug.decorators_high_vec import duplicate_debug_for_high_api


class TikDupOpsApi(TikHVecApiBase):
    """
    Vector duplicate Api
    """

    dup_ops_api = namedtuple("DupOps", "dst src api_name")

    def __init__(self):
        super(TikDupOpsApi, self).__init__()
        self.core_arch = None
        self.core_version = None
        self.ir_generator = self

    @set_tik_version_1_5()
    @duplicate_debug_for_high_api
    def dup_ops_code_make(self, code_make_params):
        """
        code maker for dup ops instruction
        """
        with self.new_scope():
            self.add_source_id()
            self.ir_generator.emit(tvm.tir.Evaluate(tvm.call_cce_intrin("int32", code_make_params.api_name,
                                    code_make_params.dst.info_node,
                                    Expr(code_make_params.src, code_make_params.dst.dtype).get()
                                    )))

    @source_info_decorator()
    def h_duplicate(self, dst, src):
        """
        vector duplicate for tik 1.5
        Parameters
        ----------
        dst: Tensor or Tensor slice
        src: Imm, Scalar, Expr

        Returns
        -------
        None
        """
        api_name = "h_duplicate"
        dup_ops_ins = TikDupOpsApi.dup_ops_api(dst, src, api_name)
        check_duplicate_params(dup_ops_ins)
        self.dup_ops_code_make(dup_ops_ins)
