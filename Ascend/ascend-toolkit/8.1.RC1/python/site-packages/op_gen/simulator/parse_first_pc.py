#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Copyright Huawei Technologies Co., Ltd. 2023-2023. All rights reserved.
"""
import os
from op_gen.simulator.reg_dump_parser import RegDumpParser
from op_gen.simulator.instr_pop_dump_parser import InstrPopDumpParser
from op_gen.simulator import utils
from op_gen.simulator.sim_const import Const


class FirstPCParser:
    def __init__(self, core_prefix: str, dump_dir: str, core_id: str) -> None:
        self.core_prefix = core_prefix
        self.dump_dir = dump_dir
        self.core_id = core_id

    def parse_reg(self):
        reg_dump_path = os.path.join(
            self.dump_dir, f"{self.core_prefix}{Const.REG_DUMP}.dump")
        if not os.path.isfile(reg_dump_path):
            return ""
        reg_parser = RegDumpParser(reg_dump_path)
        return reg_parser.get_start_pc()

    def parse_instr_pop(self):
        instr_pop_dump_path = os.path.join(self.dump_dir, f"{self.core_prefix}{Const.INSTR_POP_DUMP}.dump")
        if not utils.CheckPath.check_file(instr_pop_dump_path):
            raise utils.Dump2TraceException(
                f"{Const.INSTR_POP_DUMP} not found in {self.dump_dir}")
        instr_pop_dump_parser = InstrPopDumpParser(
            instr_pop_dump_path, self.core_id)
        return instr_pop_dump_parser.get_pc_start_addr()

    def get_first_pc(self):
        first_pc = self.parse_reg()
        if not first_pc:
            first_pc = self.parse_instr_pop()
        utils.logger.info(f"{self.core_prefix} first pc: {first_pc}")
        return first_pc
